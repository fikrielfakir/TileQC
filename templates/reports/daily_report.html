{% extends "base.html" %}

{% block title %}Daily Report - Ceramic QC{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h3 mb-0">
                <i class="bi bi-calendar-day text-primary"></i> Daily Quality Control Report
            </h1>
            <div class="d-flex gap-2">
                <input type="date" id="reportDate" class="form-control" 
                       value="{{ selected_date if selected_date else '' }}"
                       onchange="window.location.href='{{ url_for('reports.daily_report') }}?date=' + this.value">
                <button class="btn btn-outline-primary" onclick="window.print()">
                    <i class="bi bi-printer"></i> Print
                </button>
                <button class="btn btn-outline-success" onclick="exportReport()">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
        </div>
        <p class="text-muted">Comprehensive daily quality control summary for {{ selected_date.strftime('%B %d, %Y') if selected_date else 'selected date' }}</p>
    </div>
</div>

{% if report_data %}
<!-- Report Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-0">Report Summary</h5>
                        <small>Generated on {{ report_data.date }}</small>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="display-6">
                            {{ report_data.stats.overall.compliance_rate }}%
                        </div>
                        <small>Overall Compliance</small>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <div class="text-success display-6">{{ report_data.stats.overall.compliant }}</div>
                        <small class="text-muted">Compliant Tests</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="text-danger display-6">{{ report_data.stats.overall.non_compliant }}</div>
                        <small class="text-muted">Non-Compliant Tests</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="text-info display-6">{{ report_data.stats.overall.total }}</div>
                        <small class="text-muted">Total Tests</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="text-secondary display-6">8</div>
                        <small class="text-muted">Production Stages</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Production Stage Details -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-factory text-primary"></i> Production Stage Performance</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Clay Control -->
                    <div class="col-lg-6 mb-3">
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1"><i class="bi bi-layers text-warning"></i> Clay Control (PDM Argile)</h6>
                                        <small class="text-muted">{{ report_data.clay_controls|length }} measurements</small>
                                    </div>
                                    <div class="text-end">
                                        {% set clay_rate = (report_data.stats.clay.compliant / report_data.stats.clay.total * 100) if report_data.stats.clay.total > 0 else 0 %}
                                        <div class="text-{{ 'success' if clay_rate >= 95 else 'warning' if clay_rate >= 80 else 'danger' }} h5">
                                            {{ "%.1f"|format(clay_rate) }}%
                                        </div>
                                        <small class="text-muted">{{ report_data.stats.clay.compliant }}/{{ report_data.stats.clay.total }}</small>
                                    </div>
                                </div>
                                {% if report_data.clay_controls %}
                                <div class="mt-2">
                                    <small><strong>Key Parameters:</strong></small>
                                    {% for control in report_data.clay_controls[:3] %}
                                    <div class="row mt-1">
                                        <div class="col-6">
                                            <small class="text-muted">{{ control.shift|title if control.shift else 'N/A' }}</small>
                                        </div>
                                        <div class="col-6 text-end">
                                            <span class="badge bg-{{ 'success' if control.compliance_status == 'compliant' else 'danger' }}">
                                                {{ control.compliance_status|title }}
                                            </span>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Press Control -->
                    <div class="col-lg-6 mb-3">
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1"><i class="bi bi-hammer text-info"></i> Press Control</h6>
                                        <small class="text-muted">{{ report_data.press_controls|length }} measurements</small>
                                    </div>
                                    <div class="text-end">
                                        {% set press_rate = (report_data.stats.press.compliant / report_data.stats.press.total * 100) if report_data.stats.press.total > 0 else 0 %}
                                        <div class="text-{{ 'success' if press_rate >= 95 else 'warning' if press_rate >= 80 else 'danger' }} h5">
                                            {{ "%.1f"|format(press_rate) }}%
                                        </div>
                                        <small class="text-muted">{{ report_data.stats.press.compliant }}/{{ report_data.stats.press.total }}</small>
                                    </div>
                                </div>
                                {% if report_data.press_controls %}
                                <div class="mt-2">
                                    <small><strong>Format Distribution:</strong></small>
                                    {% set format_counts = {} %}
                                    {% for control in report_data.press_controls %}
                                        {% if control.format_type %}
                                            {% set _ = format_counts.update({control.format_type: format_counts.get(control.format_type, 0) + 1}) %}
                                        {% endif %}
                                    {% endfor %}
                                    {% for format_type, count in format_counts.items() %}
                                    <span class="badge bg-secondary me-1">{{ format_type }}: {{ count }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Dryer Control -->
                    <div class="col-lg-6 mb-3">
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1"><i class="bi bi-thermometer-sun text-orange"></i> Dryer Control (SÃ©choir)</h6>
                                        <small class="text-muted">{{ report_data.dryer_controls|length }} measurements</small>
                                    </div>
                                    <div class="text-end">
                                        {% set dryer_rate = (report_data.stats.dryer.compliant / report_data.stats.dryer.total * 100) if report_data.stats.dryer.total > 0 else 0 %}
                                        <div class="text-{{ 'success' if dryer_rate >= 95 else 'warning' if dryer_rate >= 80 else 'danger' }} h5">
                                            {{ "%.1f"|format(dryer_rate) }}%
                                        </div>
                                        <small class="text-muted">{{ report_data.stats.dryer.compliant }}/{{ report_data.stats.dryer.total }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Kiln Controls -->
                    <div class="col-lg-6 mb-3">
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1"><i class="bi bi-fire text-danger"></i> Kiln Controls</h6>
                                        <small class="text-muted">Biscuit: {{ report_data.biscuit_kiln_controls|length }} | Email: {{ report_data.email_kiln_controls|length }}</small>
                                    </div>
                                    <div class="text-end">
                                        {% set biscuit_rate = (report_data.stats.biscuit_kiln.compliant / report_data.stats.biscuit_kiln.total * 100) if report_data.stats.biscuit_kiln.total > 0 else 0 %}
                                        {% set email_rate = (report_data.stats.email_kiln.compliant / report_data.stats.email_kiln.total * 100) if report_data.stats.email_kiln.total > 0 else 0 %}
                                        <div class="small">
                                            <span class="text-{{ 'success' if biscuit_rate >= 95 else 'warning' if biscuit_rate >= 80 else 'danger' }}">
                                                B: {{ "%.1f"|format(biscuit_rate) }}%
                                            </span> | 
                                            <span class="text-{{ 'success' if email_rate >= 95 else 'warning' if email_rate >= 80 else 'danger' }}">
                                                E: {{ "%.1f"|format(email_rate) }}%
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Non-Conformities Section -->
{% if report_data.stats.overall.non_compliant > 0 %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle"></i> Non-Conformities Requiring Attention
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <strong>{{ report_data.stats.overall.non_compliant }} non-compliant measurements detected today.</strong>
                    Immediate corrective actions may be required.
                </div>
                
                <!-- Non-conformity breakdown by stage would go here -->
                <div class="row">
                    {% if report_data.stats.clay.non_compliant > 0 %}
                    <div class="col-md-6 mb-2">
                        <div class="alert alert-danger mb-1">
                            <strong>Clay Control:</strong> {{ report_data.stats.clay.non_compliant }} non-compliant measurements
                        </div>
                    </div>
                    {% endif %}
                    {% if report_data.stats.press.non_compliant > 0 %}
                    <div class="col-md-6 mb-2">
                        <div class="alert alert-danger mb-1">
                            <strong>Press Control:</strong> {{ report_data.stats.press.non_compliant }} non-compliant measurements
                        </div>
                    </div>
                    {% endif %}
                    {% if report_data.stats.dryer.non_compliant > 0 %}
                    <div class="col-md-6 mb-2">
                        <div class="alert alert-danger mb-1">
                            <strong>Dryer Control:</strong> {{ report_data.stats.dryer.non_compliant }} non-compliant measurements
                        </div>
                    </div>
                    {% endif %}
                    {% if report_data.stats.biscuit_kiln.non_compliant > 0 %}
                    <div class="col-md-6 mb-2">
                        <div class="alert alert-danger mb-1">
                            <strong>Biscuit Kiln:</strong> {{ report_data.stats.biscuit_kiln.non_compliant }} non-compliant measurements
                        </div>
                    </div>
                    {% endif %}
                    {% if report_data.stats.email_kiln.non_compliant > 0 %}
                    <div class="col-md-6 mb-2">
                        <div class="alert alert-danger mb-1">
                            <strong>Email Kiln:</strong> {{ report_data.stats.email_kiln.non_compliant }} non-compliant measurements
                        </div>
                    </div>
                    {% endif %}
                    {% if report_data.stats.enamel.non_compliant > 0 %}
                    <div class="col-md-6 mb-2">
                        <div class="alert alert-danger mb-1">
                            <strong>Enamel Control:</strong> {{ report_data.stats.enamel.non_compliant }} non-compliant measurements
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Recommendations Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-lightbulb text-warning"></i> Recommendations</h5>
            </div>
            <div class="card-body">
                {% if report_data.stats.overall.compliance_rate >= 98 %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i>
                    <strong>Excellent Performance:</strong> All production stages are performing within specifications. Continue current practices.
                </div>
                {% elif report_data.stats.overall.compliance_rate >= 95 %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Good Performance:</strong> Most stages are compliant. Monitor non-compliant areas for trends.
                </div>
                {% elif report_data.stats.overall.compliance_rate >= 80 %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Attention Required:</strong> Several non-conformities detected. Review processes and implement corrective actions.
                </div>
                {% else %}
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i>
                    <strong>Critical Issues:</strong> Multiple stages showing non-compliance. Immediate intervention required.
                </div>
                {% endif %}
                
                <h6 class="mt-3">Action Items:</h6>
                <ul class="mb-0">
                    {% if report_data.stats.overall.non_compliant > 0 %}
                    <li>Investigate root causes of non-compliant measurements</li>
                    <li>Implement corrective actions for failed tests</li>
                    <li>Increase monitoring frequency for problematic parameters</li>
                    {% endif %}
                    {% if report_data.stats.overall.total < 20 %}
                    <li>Ensure all required daily measurements are completed</li>
                    {% endif %}
                    <li>Review weekly test schedule for upcoming requirements</li>
                    <li>Verify calibration status of measurement equipment</li>
                </ul>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- No Data Available -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <i class="bi bi-calendar-x text-muted display-4"></i>
                <h5 class="text-muted mt-3">No Data Available</h5>
                <p class="text-muted">No quality control measurements found for {{ selected_date.strftime('%B %d, %Y') if selected_date else 'the selected date' }}.</p>
                <div class="mt-3">
                    <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i> Start Adding Measurements
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Report Footer -->
<div class="row mt-4 d-print-none">
    <div class="col-12">
        <div class="card border-0 bg-light">
            <div class="card-body text-center">
                <small class="text-muted">
                    Report generated on {{ 'now'|strftime('%Y-%m-%d %H:%M:%S') }} | 
                    Ceramic Tile Quality Control System - R2-LABO Implementation | 
                    <a href="{{ url_for('reports.daily_report') }}">Refresh Report</a>
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function exportReport() {
    const date = document.getElementById('reportDate').value;
    if (date) {
        window.open(`{{ url_for('reports.export_daily_json', date_str='DATE_PLACEHOLDER') }}`.replace('DATE_PLACEHOLDER', date), '_blank');
    } else {
        alert('Please select a date first.');
    }
}

// Auto-set today's date if no date selected
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('reportDate');
    if (!dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
});
</script>

<style>
@media print {
    .btn, .d-print-none {
        display: none !important;
    }
    .card {
        border: 1px solid #dee2e6 !important;
        box-shadow: none !important;
    }
    .card-header {
        background-color: #f8f9fa !important;
        color: #000 !important;
    }
    .bg-primary {
        background-color: #0d6efd !important;
        color: white !important;
    }
    .bg-danger {
        background-color: #dc3545 !important;
        color: white !important;
    }
}
</style>
{% endblock %}
