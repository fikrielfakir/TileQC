{% extends "base.html" %}

{% block title %}Daily Report - Ceramic QC{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h3 mb-0">
                <i class="bi bi-calendar-day text-primary"></i> Daily Quality Control Report
            </h1>
            <div class="d-flex gap-2">
                <input type="date" id="reportDate" class="form-control" 
                       value="{{ selected_date if selected_date else '' }}"
                       onchange="window.location.href='{{ url_for('reports.daily_report') }}?date=' + this.value">
                <button class="btn btn-outline-primary" onclick="window.print()">
                    <i class="bi bi-printer"></i> Print
                </button>
                <button class="btn btn-outline-success" onclick="exportReport()">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
        </div>
        <p class="text-muted">Comprehensive daily quality control summary for {{ selected_date.strftime('%B %d, %Y') if selected_date else 'selected date' }}</p>
    </div>
</div>

{% if report_data %}
<!-- Report Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-2 shadow-sm report-card">
            <div class="card-header bg-light border-bottom-2">
                <div class="row align-items-center">
                    <div class="col-md-2 text-center">
                        <img src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚙️</text></svg>" 
                             alt="Logo" style="width: 60px; height: 60px;">
                        <div><small class="fw-bold">CERAMICA DERSA</small></div>
                    </div>
                    <div class="col-md-6 text-center">
                        <h4 class="mb-1 fw-bold">FICHE CONTROLE QUALITÉ</h4>
                        <h5 class="mb-0">RAPPORT QUOTIDIEN</h5>
                    </div>
                    <div class="col-md-4">
                        <table class="table table-bordered table-sm mb-0">
                            <tr><td class="fw-bold bg-light">SERVICE LABORATOIRE</td></tr>
                            <tr><td><strong>CODE:</strong> R2-F1-LABO</td></tr>
                            <tr><td><strong>VERSION:</strong> 00</td></tr>
                            <tr><td><strong>DATE:</strong> {{ selected_date.strftime('%d/%m/%Y') }}</td></tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Contrôleur:</strong> {{ current_user.full_name or current_user.username }}
                    </div>
                    <div class="col-md-6 text-end">
                        <strong>Date:</strong> {{ selected_date.strftime('%d/%m/%Y') }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- HUMIDITE TREMIE GENERALE -->
{% if report_data.clay_controls %}
<div class="row mb-4">
    <div class="col-12">
        <table class="table table-bordered control-table">
            <thead>
                <tr class="table-secondary">
                    <th class="fw-bold">HUMIDITE TREMIE GENERALE</th>
                    <th>Contrôleur: {{ current_user.username }}</th>
                    <th>Heure: {{ report_data.clay_controls[0].measurement_time_1.strftime('%H:%M') if report_data.clay_controls[0].measurement_time_1 else 'N/A' }}</th>
                </tr>
            </thead>
            <tbody>
                <tr class="table-light">
                    <td class="fw-bold">% Humidité</td>
                    <td class="fw-bold">Spécifications</td>
                    <td class="fw-bold">N° F.N.C.</td>
                </tr>
                <tr>
                    <td>{{ "%.2f"|format(report_data.clay_controls[0].humidity_before_prep) if report_data.clay_controls[0].humidity_before_prep else 'N/A' }}%</td>
                    <td>2,5% ≤ %H ≤ 4,1%</td>
                    <td class="text-center">
                        {% if report_data.clay_controls[0].compliance_status != 'compliant' %}
                            <span class="badge bg-danger">NC</span>
                        {% else %}
                            <span class="text-success">✓</span>
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- HUMIDITE APRES TAMISAGE -->
<div class="row mb-4">
    <div class="col-12">
        <table class="table table-bordered control-table">
            <thead>
                <tr class="table-secondary">
                    <th class="fw-bold">HUMIDITE APRES TAMISAGE</th>
                    <th>Contrôleur: {{ current_user.username }}</th>
                    <th>Heure: {{ report_data.clay_controls[0].measurement_time_1.strftime('%H:%M') if report_data.clay_controls[0].measurement_time_1 else 'N/A' }}</th>
                </tr>
            </thead>
            <tbody>
                <tr class="table-light">
                    <td class="fw-bold">% Humidité</td>
                    <td class="fw-bold">Spécifications</td>
                    <td class="fw-bold">N° F.N.C.</td>
                </tr>
                <tr>
                    <td>{{ "%.2f"|format(report_data.clay_controls[0].humidity_after_sieving) if report_data.clay_controls[0].humidity_after_sieving else 'N/A' }}%</td>
                    <td>2% ≤ H ≤ 3,5%</td>
                    <td class="text-center">
                        {% if report_data.clay_controls[0].compliance_status != 'compliant' %}
                            <span class="badge bg-danger">NC</span>
                        {% else %}
                            <span class="text-success">✓</span>
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- HUMIDITE SILOS -->
<div class="row mb-4">
    <div class="col-12">
        <table class="table table-bordered control-table">
            <thead>
                <tr class="table-secondary">
                    <th class="fw-bold">HUMIDITE SILOS</th>
                    <th colspan="2">Contrôleur: {{ current_user.username }}</th>
                </tr>
            </thead>
            <tbody>
                <tr class="table-light">
                    <td class="fw-bold">Heure</td>
                    <td class="fw-bold">N° Silo</td>
                    <td class="fw-bold">% humidité</td>
                    <td class="fw-bold">Spécifications</td>
                    <td class="fw-bold">N° F.N.C.</td>
                </tr>
                {% for control in report_data.clay_controls[:4] %}
                <tr>
                    <td>{{ control.measurement_time_1.strftime('%H:%M') if control.measurement_time_1 else 'N/A' }}</td>
                    <td>Silo {{ loop.index }}</td>
                    <td>{{ "%.1f"|format(control.humidity_after_prep) if control.humidity_after_prep else 'N/A' }}%</td>
                    <td>5,3% ≤ H ≤ 6,3%</td>
                    <td class="text-center">
                        {% if control.compliance_status != 'compliant' %}
                            <span class="badge bg-danger">NC</span>
                        {% else %}
                            <span class="text-success">✓</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                <tr class="table-light">
                    <td colspan="5" class="fw-bold text-center">Humidité Moyenne</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- HUMIDITE ARGILE PRESSE -->
{% if report_data.press_controls %}
<div class="row mb-4">
    <div class="col-12">
        <table class="table table-bordered control-table">
            <thead>
                <tr class="table-secondary">
                    <th class="fw-bold">HUMIDITE ARGILE PRESSE</th>
                    <th>Contrôleur: {{ current_user.username }}</th>
                    <th>Heure: {{ report_data.press_controls[0].measurement_time.strftime('%H:%M') if report_data.press_controls[0].measurement_time else 'N/A' }}</th>
                </tr>
            </thead>
            <tbody>
                <tr class="table-light">
                    <td class="fw-bold">N° Silo</td>
                    <td class="fw-bold">% Humidité</td>
                    <td class="fw-bold">Spécifications</td>
                    <td class="fw-bold">N° F.N.C.</td>
                </tr>
                <tr>
                    <td>{{ report_data.press_controls[0].format_type or 'N/A' }}</td>
                    <td>{{ "%.1f"|format(report_data.press_controls[0].thickness) if report_data.press_controls[0].thickness else 'N/A' }}%</td>
                    <td>5,2 ≤ % Humidité ≤ 6%</td>
                    <td class="text-center">
                        {% if report_data.press_controls[0].compliance_status != 'compliant' %}
                            <span class="badge bg-danger">NC</span>
                        {% else %}
                            <span class="text-success">✓</span>
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- HUMIDITE RESIDUELLE SECHOIR -->
{% if report_data.dryer_controls %}
<div class="row mb-4">
    <div class="col-12">
        <table class="table table-bordered control-table">
            <thead>
                <tr class="table-secondary">
                    <th class="fw-bold">HUMIDITE RESIDUELLE SECHOIR</th>
                    <th>Contrôleur: {{ current_user.username }}</th>
                    <th>Heure: {{ report_data.dryer_controls[0].measurement_time.strftime('%H:%M') if report_data.dryer_controls[0].measurement_time else 'N/A' }}</th>
                </tr>
            </thead>
            <tbody>
                <tr class="table-light">
                    <td class="fw-bold">% Humidité</td>
                    <td class="fw-bold">Spécifications</td>
                    <td class="fw-bold">N° F.N.C.</td>
                </tr>
                <tr>
                    <td>{{ "%.2f"|format(report_data.dryer_controls[0].residual_humidity) if report_data.dryer_controls[0].residual_humidity else 'N/A' }}%</td>
                    <td>0,1%≤ % HRM ≤1,5%</td>
                    <td class="text-center">
                        {% if report_data.dryer_controls[0].compliance_status != 'compliant' %}
                            <span class="badge bg-danger">NC</span>
                        {% else %}
                            <span class="text-success">✓</span>
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- SIGNATURE SECTION -->
<div class="row mb-4">
    <div class="col-12">
        <table class="table table-borderless">
            <tbody>
                <tr>
                    <td class="text-start"><strong>Visa Contrôleur</strong></td>
                    <td class="text-end"><strong>Visa Service Laboratoire</strong></td>
                </tr>
                <tr>
                    <td style="height: 60px; border-bottom: 1px solid #000; width: 50%;"></td>
                    <td style="height: 60px; border-bottom: 1px solid #000; width: 50%;"></td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Non-Conformities Section -->
{% if report_data.stats.overall.non_compliant > 0 %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle"></i> Non-Conformities Requiring Attention
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <strong>{{ report_data.stats.overall.non_compliant }} non-compliant measurements detected today.</strong>
                    Immediate corrective actions may be required.
                </div>
                
                <!-- Non-conformity breakdown by stage would go here -->
                <div class="row">
                    {% if report_data.stats.clay.non_compliant > 0 %}
                    <div class="col-md-6 mb-2">
                        <div class="alert alert-danger mb-1">
                            <strong>Clay Control:</strong> {{ report_data.stats.clay.non_compliant }} non-compliant measurements
                        </div>
                    </div>
                    {% endif %}
                    {% if report_data.stats.press.non_compliant > 0 %}
                    <div class="col-md-6 mb-2">
                        <div class="alert alert-danger mb-1">
                            <strong>Press Control:</strong> {{ report_data.stats.press.non_compliant }} non-compliant measurements
                        </div>
                    </div>
                    {% endif %}
                    {% if report_data.stats.dryer.non_compliant > 0 %}
                    <div class="col-md-6 mb-2">
                        <div class="alert alert-danger mb-1">
                            <strong>Dryer Control:</strong> {{ report_data.stats.dryer.non_compliant }} non-compliant measurements
                        </div>
                    </div>
                    {% endif %}
                    {% if report_data.stats.biscuit_kiln.non_compliant > 0 %}
                    <div class="col-md-6 mb-2">
                        <div class="alert alert-danger mb-1">
                            <strong>Biscuit Kiln:</strong> {{ report_data.stats.biscuit_kiln.non_compliant }} non-compliant measurements
                        </div>
                    </div>
                    {% endif %}
                    {% if report_data.stats.email_kiln.non_compliant > 0 %}
                    <div class="col-md-6 mb-2">
                        <div class="alert alert-danger mb-1">
                            <strong>Email Kiln:</strong> {{ report_data.stats.email_kiln.non_compliant }} non-compliant measurements
                        </div>
                    </div>
                    {% endif %}
                    {% if report_data.stats.enamel.non_compliant > 0 %}
                    <div class="col-md-6 mb-2">
                        <div class="alert alert-danger mb-1">
                            <strong>Enamel Control:</strong> {{ report_data.stats.enamel.non_compliant }} non-compliant measurements
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Recommendations Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-lightbulb text-warning"></i> Recommendations</h5>
            </div>
            <div class="card-body">
                {% if report_data.stats.overall.compliance_rate >= 98 %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i>
                    <strong>Excellent Performance:</strong> All production stages are performing within specifications. Continue current practices.
                </div>
                {% elif report_data.stats.overall.compliance_rate >= 95 %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Good Performance:</strong> Most stages are compliant. Monitor non-compliant areas for trends.
                </div>
                {% elif report_data.stats.overall.compliance_rate >= 80 %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Attention Required:</strong> Several non-conformities detected. Review processes and implement corrective actions.
                </div>
                {% else %}
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i>
                    <strong>Critical Issues:</strong> Multiple stages showing non-compliance. Immediate intervention required.
                </div>
                {% endif %}
                
                <h6 class="mt-3">Action Items:</h6>
                <ul class="mb-0">
                    {% if report_data.stats.overall.non_compliant > 0 %}
                    <li>Investigate root causes of non-compliant measurements</li>
                    <li>Implement corrective actions for failed tests</li>
                    <li>Increase monitoring frequency for problematic parameters</li>
                    {% endif %}
                    {% if report_data.stats.overall.total < 20 %}
                    <li>Ensure all required daily measurements are completed</li>
                    {% endif %}
                    <li>Review weekly test schedule for upcoming requirements</li>
                    <li>Verify calibration status of measurement equipment</li>
                </ul>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- No Data Available -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <i class="bi bi-calendar-x text-muted display-4"></i>
                <h5 class="text-muted mt-3">Aucune Donnée Disponible</h5>
                <p class="text-muted">Aucune mesure de contrôle qualité trouvée pour {{ selected_date.strftime('%d %B %Y') if selected_date else 'la date sélectionnée' }}.</p>
                <div class="mt-3">
                    <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i> Commencer à Ajouter des Mesures
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Report Footer -->
<div class="row mt-4 d-print-none">
    <div class="col-12">
        <div class="card border-0 bg-light">
            <div class="card-body text-center">
                <small class="text-muted">
                    Rapport généré le {{ 'now'|strftime('%d/%m/%Y à %H:%M:%S') }} | 
                    Système de Contrôle Qualité Carreaux Céramiques - Implémentation R2-LABO | 
                    <a href="{{ url_for('reports.daily_report') }}">Actualiser le Rapport</a>
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function exportReport() {
    const date = document.getElementById('reportDate').value;
    if (date) {
        window.open(`{{ url_for('reports.export_daily_json', date_str='DATE_PLACEHOLDER') }}`.replace('DATE_PLACEHOLDER', date), '_blank');
    } else {
        alert('Please select a date first.');
    }
}

// Auto-set today's date if no date selected
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('reportDate');
    if (!dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
});
</script>

<style>
.control-table {
    border: 2px solid #000 !important;
    margin-bottom: 1rem;
}

.control-table th,
.control-table td {
    border: 1px solid #000 !important;
    padding: 8px !important;
    text-align: center !important;
    vertical-align: middle !important;
}

.control-table .table-secondary {
    background-color: #e9ecef !important;
    font-weight: bold !important;
}

.control-table .table-light {
    background-color: #f8f9fa !important;
}

.report-card {
    border: 2px solid #000 !important;
    box-shadow: none !important;
}

.border-bottom-2 {
    border-bottom: 2px solid #000 !important;
}

.border-2 {
    border: 2px solid #000 !important;
}

@media print {
    .btn, .d-print-none {
        display: none !important;
    }
    .card {
        border: 2px solid #000 !important;
        box-shadow: none !important;
    }
    .card-header {
        background-color: #f8f9fa !important;
        color: #000 !important;
    }
    .control-table {
        border: 2px solid #000 !important;
        break-inside: avoid;
    }
    .control-table th,
    .control-table td {
        border: 1px solid #000 !important;
        padding: 4px !important;
    }
    body {
        font-size: 12px !important;
    }
    h4, h5 {
        font-size: 14px !important;
    }
}
</style>
{% endblock %}
