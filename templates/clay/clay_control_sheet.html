{% extends "base.html" %}

{% block title %}Fiche de Contrôle Argile{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row no-print mb-3">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="bi bi-layers-fill text-primary"></i> Fiche de Contrôle Argile</h2>
                <div>
                    <button onclick="fillCurrentData()" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-calendar-fill"></i> Remplir Date Actuelle
                    </button>
                    <button onclick="window.print()" class="btn btn-primary btn-sm">
                        <i class="bi bi-printer-fill"></i> Imprimer
                    </button>
                    <a href="{{ url_for('clay.clay_controls') }}" class="btn btn-secondary btn-sm">
                        <i class="bi bi-arrow-left"></i> Retour
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Sheet Form -->
    <div class="control-sheet">
        <!-- Header Table -->
        <table class="table table-bordered control-header-table">
            <tr>
                <td rowspan="4" class="logo-cell text-center">
                    <div class="company-logo">
                        <strong>سيراميكا درسة</strong><br>
                        <small>CERAMICA DERSA</small>
                    </div>
                </td>
                <td class="title-cell text-center">
                    <h3 class="mb-0"><strong>FICHE DE CONTRÔLE ARGILE</strong></h3>
                </td>
                <td class="service-header"><strong>SERVICE LABORATOIRE</strong></td>
            </tr>
            <tr>
                <td rowspan="3" class="title-spacer"></td>
                <td class="info-field">
                    <strong>CODE</strong> : R2-F2-LABO
                </td>
            </tr>
            <tr>
                <td class="info-field">
                    <strong>VERSION</strong> : 02
                </td>
            </tr>
            <tr>
                <td class="info-field">
                    <strong>DATE</strong> : <input type="text" class="form-control-plaintext d-inline" 
                           style="width: 120px; border-bottom: 1px solid #000;" 
                           id="headerDate" placeholder="01/01/2022">
                </td>
            </tr>
        </table>

        <!-- Main Control Table -->
        <table class="table table-bordered control-main-table">
            <thead>
                <tr class="table-secondary">
                    <th rowspan="2" class="control-col">CONTRÔLE</th>
                    <th rowspan="2" class="spec-col">Spécifications techniques</th>
                    <th colspan="8" class="date-cols">Date de contrôle</th>
                </tr>
                <tr class="table-secondary">
                    <th class="date-cell">..../.../.....</th>
                    <th class="date-cell">..../.../.....</th>
                    <th class="date-cell">..../.../.....</th>
                    <th class="date-cell">..../.../.....</th>
                    <th class="date-cell">..../.../.....</th>
                    <th class="date-cell">..../.../.....</th>
                    <th class="date-cell">..../.../.....</th>
                    <th class="date-cell">..../.../.....</th>
                </tr>
            </thead>
            <tbody>
                <!-- GRANULOMÉTRIE Section -->
                <tr class="section-header">
                    <td colspan="10" class="section-title"><strong>GRANULOMÉTRIE</strong></td>
                </tr>
                <tr>
                    <td class="granulo-cell">X1≥600 μ</td>
                    <td class="spec-value">0%≤ Granul.≤0,02%</td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                </tr>
                <tr>
                    <td class="granulo-cell">425 μ <X2≤ 600 μ</td>
                    <td class="spec-value">0%≤ Granul.≤0,05%</td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                </tr>
                <tr>
                    <td class="granulo-cell">300 μ <X3≤ 425 μ</td>
                    <td class="spec-value">0,1≤ Granul.≤0,6%</td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                </tr>
                <tr>
                    <td class="granulo-cell">250 μ <X4≤ 300 μ</td>
                    <td class="spec-value">0,2≤ Granul.≤1%</td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                </tr>
                <tr>
                    <td class="granulo-cell">180 μ <X5≤ 250 μ</td>
                    <td class="spec-value">0,6≤ Granul.≤2%</td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                </tr>
                <tr class="total-row">
                    <td class="granulo-cell"><strong>Total</strong></td>
                    <td class="spec-value"></td>
                    <td class="total-cell"><span class="total-value">0</span>%</td>
                    <td class="total-cell"><span class="total-value">0</span>%</td>
                    <td class="total-cell"><span class="total-value">0</span>%</td>
                    <td class="total-cell"><span class="total-value">0</span>%</td>
                    <td class="total-cell"><span class="total-value">0</span>%</td>
                    <td class="total-cell"><span class="total-value">0</span>%</td>
                    <td class="total-cell"><span class="total-value">0</span>%</td>
                    <td class="total-cell"><span class="total-value">0</span>%</td>
                </tr>
                
                <!-- Continue with next sections -->
                <tr>
                    <td class="granulo-cell">125 μ <X6≤ 180 μ</td>
                    <td class="spec-value">0,2≤ Granul.≤0,7%</td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                </tr>
                <tr>
                    <td class="granulo-cell">63 μ <X7≤ 125 μ</td>
                    <td class="spec-value">0,8≤ Granul.≤20%</td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                </tr>
                <tr class="total-row">
                    <td class="granulo-cell"><strong>Total</strong></td>
                    <td class="spec-value"></td>
                    <td class="total-cell"><span class="total-value-2">0</span>%</td>
                    <td class="total-cell"><span class="total-value-2">0</span>%</td>
                    <td class="total-cell"><span class="total-value-2">0</span>%</td>
                    <td class="total-cell"><span class="total-value-2">0</span>%</td>
                    <td class="total-cell"><span class="total-value-2">0</span>%</td>
                    <td class="total-cell"><span class="total-value-2">0</span>%</td>
                    <td class="total-cell"><span class="total-value-2">0</span>%</td>
                    <td class="total-cell"><span class="total-value-2">0</span>%</td>
                </tr>
                
                <tr>
                    <td class="granulo-cell"><X8≤ 63 μ</td>
                    <td class="spec-value">60≤ Granul.≤90%</td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                </tr>
                
                <tr>
                    <td class="granulo-cell">Refus 63 μ</td>
                    <td class="spec-value">10≤Refus≤20%</td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.001" class="form-control"></td>
                </tr>
                
                <!-- N° Fiche de non-conformité -->
                <tr class="nc-row">
                    <td class="granulo-cell"><strong>N° Fiche de non-conformité :</strong></td>
                    <td class="spec-value"></td>
                    <td class="input-cell"><input type="text" class="form-control"></td>
                    <td class="input-cell"><input type="text" class="form-control"></td>
                    <td class="input-cell"><input type="text" class="form-control"></td>
                    <td class="input-cell"><input type="text" class="form-control"></td>
                    <td class="input-cell"><input type="text" class="form-control"></td>
                    <td class="input-cell"><input type="text" class="form-control"></td>
                    <td class="input-cell"><input type="text" class="form-control"></td>
                    <td class="input-cell"><input type="text" class="form-control"></td>
                </tr>
                
                <!-- CaCO3 Section -->
                <tr class="caco3-row">
                    <td class="granulo-cell">% CaCo3</td>
                    <td class="spec-value">15 % ≤ % CaCo3 ≤ 25 %</td>
                    <td class="input-cell"><input type="number" step="0.1" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.1" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.1" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.1" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.1" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.1" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.1" class="form-control"></td>
                    <td class="input-cell"><input type="number" step="0.1" class="form-control"></td>
                </tr>
                
                <!-- Second N° Fiche de non-conformité -->
                <tr class="nc-row">
                    <td class="granulo-cell"><strong>N° Fiche de non-conformité :</strong></td>
                    <td class="spec-value"></td>
                    <td class="input-cell"><input type="text" class="form-control"></td>
                    <td class="input-cell"><input type="text" class="form-control"></td>
                    <td class="input-cell"><input type="text" class="form-control"></td>
                    <td class="input-cell"><input type="text" class="form-control"></td>
                    <td class="input-cell"><input type="text" class="form-control"></td>
                    <td class="input-cell"><input type="text" class="form-control"></td>
                    <td class="input-cell"><input type="text" class="form-control"></td>
                    <td class="input-cell"><input type="text" class="form-control"></td>
                </tr>
            </tbody>
        </table>

        <!-- Signature Section -->
        <table class="table table-bordered signature-table">
            <tbody>
                <tr>
                    <td class="signature-cell text-center">
                        <strong>Nom & visa<br>Contrôleur</strong>
                        <div class="signature-box"></div>
                    </td>
                    <td class="signature-cell text-center" colspan="8">
                        <div class="signature-grid">
                            <div class="signature-item"></div>
                            <div class="signature-item"></div>
                            <div class="signature-item"></div>
                            <div class="signature-item"></div>
                            <div class="signature-item"></div>
                            <div class="signature-item"></div>
                            <div class="signature-item"></div>
                            <div class="signature-item"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="signature-cell text-center">
                        <strong>Visa Responsable<br>Laboratoire</strong>
                        <div class="signature-box"></div>
                    </td>
                    <td class="signature-cell" colspan="8">
                        <div class="signature-grid">
                            <div class="signature-item"></div>
                            <div class="signature-item"></div>
                            <div class="signature-item"></div>
                            <div class="signature-item"></div>
                            <div class="signature-item"></div>
                            <div class="signature-item"></div>
                            <div class="signature-item"></div>
                            <div class="signature-item"></div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<style>
.control-sheet {
    font-family: Arial, sans-serif;
    font-size: 11px;
    max-width: 297mm;
    margin: 0 auto;
}

.control-header-table {
    border: 2px solid #000;
    margin-bottom: 20px;
    width: 100%;
}

.logo-cell {
    width: 15%;
    background-color: #f8f9fa;
    border-right: 2px solid #000;
    vertical-align: middle;
    font-weight: bold;
}

.title-cell {
    width: 60%;
    background-color: #f8f9fa;
    vertical-align: middle;
    font-size: 16px;
    border-right: 2px solid #000;
}

.service-header {
    width: 25%;
    background-color: #f8f9fa;
    text-align: center;
    vertical-align: middle;
    font-size: 12px;
    font-weight: bold;
}

.info-field {
    background-color: #f8f9fa;
    padding: 6px;
    text-align: left;
    font-size: 11px;
}

.control-main-table {
    border: 2px solid #000;
    margin-bottom: 15px;
    font-size: 10px;
    width: 100%;
}

.control-main-table th,
.control-main-table td {
    border: 1px solid #000;
    text-align: center;
    padding: 4px;
    vertical-align: middle;
}

.control-col {
    width: 15%;
    font-weight: bold;
}

.spec-col {
    width: 20%;
    font-weight: bold;
}

.date-cols {
    width: 65%;
}

.date-cell {
    width: 8.125%;
    font-size: 9px;
}

.section-header {
    background-color: #e9ecef;
}

.section-title {
    font-weight: bold;
    text-align: left;
    padding-left: 10px;
}

.granulo-cell {
    text-align: left;
    font-size: 9px;
    padding-left: 8px;
}

.spec-value {
    font-size: 9px;
    text-align: center;
    background-color: #f8f9fa;
}

.input-cell input {
    border: none;
    background: transparent;
    text-align: center;
    font-size: 9px;
    padding: 2px;
    width: 100%;
    height: 30px;
}

.total-row {
    background-color: #f1f3f4;
    font-weight: bold;
}

.total-cell {
    background-color: #f1f3f4;
    font-weight: bold;
}

.nc-row {
    background-color: #fff3cd;
}

.caco3-row {
    background-color: #d1ecf1;
}

.signature-table {
    border: 2px solid #000;
    margin-top: 20px;
}

.signature-cell {
    height: 80px;
    vertical-align: top;
    padding: 10px;
}

.signature-box {
    border: 1px solid #ccc;
    height: 50px;
    margin-top: 5px;
}

.signature-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 2px;
    height: 50px;
}

.signature-item {
    border: 1px solid #ccc;
}

@media print {
    .no-print {
        display: none !important;
    }
    
    .control-sheet {
        margin: 0;
        padding: 0;
    }
    
    body {
        font-size: 9px;
    }
    
    .control-main-table {
        page-break-inside: avoid;
    }
}
</style>

<script>
function fillCurrentData() {
    const now = new Date();
    const dateStr = now.toLocaleDateString('fr-FR');
    
    // Fill header date
    document.getElementById('headerDate').value = dateStr;
    
    // Fill date headers in the main table
    const dateHeaders = document.querySelectorAll('.date-cell');
    dateHeaders.forEach((cell, index) => {
        if (index < 8) {
            cell.textContent = dateStr;
        }
    });
}

// Auto-calculate totals for granulometry
document.addEventListener('DOMContentLoaded', function() {
    const inputRows = [
        [0, 1, 2, 3, 4], // First total (rows 0-4)
        [5, 6], // Second total (rows 5-6)
    ];
    
    function calculateTotals() {
        // Calculate first total (rows 0-4)
        for (let col = 0; col < 8; col++) {
            let total1 = 0;
            for (let row = 0; row < 5; row++) {
                const input = document.querySelector(`tbody tr:nth-child(${row + 2}) td:nth-child(${col + 3}) input`);
                if (input && input.value) {
                    total1 += parseFloat(input.value);
                }
            }
            const totalSpan1 = document.querySelector(`tbody tr:nth-child(7) td:nth-child(${col + 3}) .total-value`);
            if (totalSpan1) {
                totalSpan1.textContent = total1.toFixed(3);
            }
        }
        
        // Calculate second total (rows 5-6)  
        for (let col = 0; col < 8; col++) {
            let total2 = 0;
            for (let row = 7; row < 9; row++) {
                const input = document.querySelector(`tbody tr:nth-child(${row + 2}) td:nth-child(${col + 3}) input`);
                if (input && input.value) {
                    total2 += parseFloat(input.value);
                }
            }
            const totalSpan2 = document.querySelector(`tbody tr:nth-child(11) td:nth-child(${col + 3}) .total-value-2`);
            if (totalSpan2) {
                totalSpan2.textContent = total2.toFixed(3);
            }
        }
    }
    
    // Add event listeners to all input fields
    const allInputs = document.querySelectorAll('input[type="number"]');
    allInputs.forEach(input => {
        input.addEventListener('input', calculateTotals);
    });
});
</script>
{% endblock %}