{% extends "base.html" %}

{% block title %}Fiche R2-F1-LABO - Contrôles d'Humidité{% endblock %}

{% block head %}
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    background-color: white;
    color: black;
}

.r2-form-container {
    max-width: 800px;
    margin: 20px auto;
    background-color: white;
    border: 3px solid black;
    padding: 0;
    font-family: Arial, sans-serif;
    font-size: 12px;
    color: black;
}

/* Header Section */
.header-section {
    display: flex;
    border-bottom: 3px solid black;
    background-color: white;
}

.header-item {
    flex: 1;
    padding: 12px;
    border-right: 3px solid black;
    display: flex;
    align-items: center;
    gap: 10px;
    background-color: white;
}

.header-item:last-child {
    border-right: none;
}

.header-item label {
    font-weight: bold;
    white-space: nowrap;
    color: black;
}

/* Section Styles */
.section {
    border-bottom: 3px solid black;
    background-color: white;
}

.section:last-of-type {
    border-bottom: none;
}

.section-header {
    background-color: white;
    border: 2px solid black;
    padding: 10px 12px;
    font-weight: bold;
    text-align: center;
    font-size: 13px;
    color: black;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.section-content {
    display: table;
    width: 100%;
    border-collapse: collapse;
    background-color: white;
}

.row {
    display: table-row;
}

.cell {
    display: table-cell;
    border: 2px solid black;
    padding: 8px 10px;
    vertical-align: middle;
    text-align: center;
    position: relative;
    min-height: 35px;
    background-color: white;
    color: black;
}

.cell:first-child {
    border-left: none;
}

.cell:last-child {
    border-right: none;
}

/* Specific styling for different sections */
.specification {
    background-color: white;
    font-weight: bold;
    border: 3px solid black;
    color: black;
}

.specification-value {
    background-color: white;
    font-weight: bold;
    font-size: 12px;
    border: 3px solid black;
    color: black;
}

/* Input styles */
input[type="text"], input[type="time"], input[type="number"] {
    border: none;
    background: transparent;
    outline: none;
    font-size: inherit;
    font-family: inherit;
    text-align: center;
    width: 100%;
    color: black;
    font-weight: bold;
}

.dotted-line {
    border-bottom: 2px dotted black !important;
    min-width: 200px;
    padding: 3px 5px;
    color: black;
    font-weight: bold;
}

.dotted-line-small {
    border-bottom: 2px dotted black !important;
    min-width: 60px;
    padding: 3px 5px;
    display: inline-block;
    color: black;
    font-weight: bold;
}

/* Footer Section */
.footer-section {
    display: flex;
    border-top: 3px solid black;
    margin-top: 0;
    background-color: white;
}

.footer-item {
    flex: 1;
    padding: 20px;
    border-right: 3px solid black;
    text-align: center;
    font-weight: bold;
    color: black;
    background-color: white;
}

.footer-item:last-child {
    border-right: none;
}

/* Header row styling */
.header-row .cell {
    background-color: white;
    font-weight: bold;
    font-size: 11px;
    border: 3px solid black;
    color: black;
}

/* Special styling for merged cells effect */
.colspan-5 {
    text-align: center;
    font-weight: bold;
    background-color: white;
    border: 3px solid black;
    color: black;
}

/* Silo section specific styling */
.silo-specification {
    background-color: white;
    font-weight: bold;
    font-size: 11px;
    writing-mode: vertical-lr;
    text-orientation: mixed;
    border: 3px solid black;
    color: black;
}

/* Remove all Bootstrap colors */
.alert-info {
    background-color: white;
    border: 2px solid black;
    color: black;
}

.btn-primary {
    background-color: white;
    border: 2px solid black;
    color: black;
}

.btn-primary:hover {
    background-color: black;
    color: white;
}

.btn-outline-secondary {
    background-color: white;
    border: 2px solid black;
    color: black;
}

.btn-outline-secondary:hover {
    background-color: black;
    color: white;
}

.btn-info {
    background-color: white;
    border: 2px solid black;
    color: black;
}

.btn-info:hover {
    background-color: black;
    color: white;
}

@media (max-width: 768px) {
    .r2-form-container {
        margin: 10px;
        padding: 0;
    }
    
    .cell {
        font-size: 10px;
        padding: 6px;
    }
    
    .header-item {
        flex-direction: column;
        gap: 5px;
    }
}

@media print {
    .r2-form-container {
        margin: 0;
        box-shadow: none;
    }
    
    .no-print {
        display: none;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="h3 mb-0">
                <i class="bi bi-file-earmark-text text-primary"></i> Fiche R2-F1-LABO
            </h1>
            <a href="{{ url_for('clay.clay_controls') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Retour
            </a>
        </div>
        <p class="text-muted">Contrôles d'humidité complets selon la fiche R2-F1-LABO</p>
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>Remplissage automatique :</strong> Cette fiche se remplit automatiquement avec les mesures d'humidité les plus récentes d'aujourd'hui.
        </div>
    </div>
</div>

<form method="POST" id="r2F1LaboForm">
    {{ form.hidden_tag() }}
    
    <div class="r2-form-container">
        <!-- Header Section -->
        <div class="header-section">
            <div class="header-item">
                <label>Contrôleur :</label>
                <input type="text" class="dotted-line" value="{{ current_user.full_name or current_user.username }}" readonly>
            </div>
            <div class="header-item">
                <label>Date :</label>
                {{ form.date(class="dotted-line") }}
            </div>
        </div>

        <!-- HUMIDITE TREMIE GENERALE Section -->
        <div class="section">
            <div class="section-header">HUMIDITE TREMIE GENERALE</div>
            <div class="section-content">
                <div class="row">
                    <div class="cell">% Humidité<br>{{ form.humidity_before_prep(class="form-control-plaintext") }}</div>
                    <div class="cell">Contrôleur : {{ form.measurement_time_1(class="dotted-line-small", placeholder="........................") }}</div>
                    <div class="cell">Heure : {{ form.measurement_time_1(class="dotted-line-small", placeholder=".......H.......") }}</div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell specification">Spécifications</div>
                    <div class="cell">N° F.N.C.</div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell specification-value">2,5 % ≤ % H ≤ 4,1 %</div>
                    <div class="cell"></div>
                </div>
            </div>
        </div>

        <!-- HUMIDITE APRES TAMISAGE Section -->
        <div class="section">
            <div class="section-header">HUMIDITE APRES TAMISAGE</div>
            <div class="section-content">
                <div class="row">
                    <div class="cell">% Humidité<br>{{ form.humidity_after_sieving(class="form-control-plaintext") }}</div>
                    <div class="cell">Contrôleur : {{ form.measurement_time_2(class="dotted-line-small", placeholder="........................") }}</div>
                    <div class="cell">Heure : {{ form.measurement_time_2(class="dotted-line-small", placeholder=".......H.......") }}</div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell specification">Spécifications</div>
                    <div class="cell">N° F.N.C.</div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell specification-value">2 % ≤ H ≤ 3,5 %</div>
                    <div class="cell"></div>
                </div>
            </div>
        </div>

        <!-- HUMIDITE SILOS Section -->
        <div class="section">
            <div class="section-header">HUMIDITE SILOS</div>
            <div class="section-content">
                <div class="row header-row">
                    <div class="cell">Heure</div>
                    <div class="cell">N° Silo</div>
                    <div class="cell">% humidité</div>
                    <div class="cell">Contrôleur : {{ form.measurement_time_1(class="dotted-line-small", placeholder="........................") }}</div>
                    <div class="cell">N° F.N.C.</div>
                </div>
                <div class="silo-rows">
                    <div class="row">
                        <div class="cell">{{ form.silo_time_1(class="dotted-line-small", placeholder=".......H.......") }}</div>
                        <div class="cell">{{ form.silo_number_1(class="dotted-line-small") }}</div>
                        <div class="cell">{{ form.silo_humidity_1(class="dotted-line-small") }}</div>
                        <div class="cell silo-specification">5,3 % ≤ H ≤ 6,3 %</div>
                        <div class="cell"></div>
                    </div>
                    <div class="row">
                        <div class="cell">{{ form.silo_time_2(class="dotted-line-small", placeholder=".......H.......") }}</div>
                        <div class="cell">{{ form.silo_number_2(class="dotted-line-small") }}</div>
                        <div class="cell">{{ form.silo_humidity_2(class="dotted-line-small") }}</div>
                        <div class="cell"></div>
                        <div class="cell"></div>
                    </div>
                    <div class="row">
                        <div class="cell">{{ form.silo_time_3(class="dotted-line-small", placeholder=".......H.......") }}</div>
                        <div class="cell">{{ form.silo_number_3(class="dotted-line-small") }}</div>
                        <div class="cell">{{ form.silo_humidity_3(class="dotted-line-small") }}</div>
                        <div class="cell"></div>
                        <div class="cell"></div>
                    </div>
                    <div class="row">
                        <div class="cell">{{ form.silo_time_4(class="dotted-line-small", placeholder=".......H.......") }}</div>
                        <div class="cell">{{ form.silo_number_4(class="dotted-line-small") }}</div>
                        <div class="cell">{{ form.silo_humidity_4(class="dotted-line-small") }}</div>
                        <div class="cell"></div>
                        <div class="cell"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="cell colspan-5">Humidité Moyenne</div>
                </div>
            </div>
        </div>

        <!-- HUMIDITE ARGILE PRESSE Section -->
        <div class="section">
            <div class="section-header">HUMIDITE ARGILE PRESSE</div>
            <div class="section-content">
                <div class="row">
                    <div class="cell">N° Silo<br>{{ form.press_silo_number(class="dotted-line-small") }}</div>
                    <div class="cell">% Humidité<br>{{ form.press_humidity(class="dotted-line-small") }}</div>
                    <div class="cell">Contrôleur : {{ form.measurement_time_1(class="dotted-line-small", placeholder="........................") }}</div>
                    <div class="cell">Heure : {{ form.press_time(class="dotted-line-small", placeholder=".......H.......") }}</div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell specification">Spécifications</div>
                    <div class="cell">N° F.N.C.</div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell"></div>
                    <div class="cell specification-value">5,2 ≤ % Humidité ≤ 6 %</div>
                    <div class="cell"></div>
                </div>
            </div>
        </div>

        <!-- HUMIDITE RESIDUELLE SECHOIR Section -->
        <div class="section">
            <div class="section-header">HUMIDITE RESIDUELLE SECHOIR</div>
            <div class="section-content">
                <div class="row">
                    <div class="cell">% Humidité<br>{{ form.residual_humidity(class="dotted-line-small") }}</div>
                    <div class="cell">Contrôleur : {{ form.measurement_time_1(class="dotted-line-small", placeholder="........................") }}</div>
                    <div class="cell">Heure : {{ form.dryer_time(class="dotted-line-small", placeholder=".......H.......") }}</div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell specification">Spécifications</div>
                    <div class="cell">N° F.N.C.</div>
                </div>
                <div class="row">
                    <div class="cell"></div>
                    <div class="cell specification-value">0,1%≤ % HRM ≤1,5%</div>
                    <div class="cell"></div>
                </div>
            </div>
        </div>

        <!-- Footer Section -->
        <div class="footer-section">
            <div class="footer-item">
                <label>Visa Contrôleur</label>
            </div>
            <div class="footer-item">
                <label>Visa Service Laboratoire</label>
            </div>
        </div>
    </div>

    <!-- Action buttons -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <div class="d-flex gap-2 justify-content-center">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg"></i> Enregistrer Fiche R2-F1-LABO
                </button>
                <a href="{{ url_for('clay.clay_controls') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Annuler
                </a>
                <button type="button" class="btn btn-info" onclick="window.print()">
                    <i class="bi bi-printer"></i> Imprimer
                </button>
            </div>
        </div>
    </div>

    <!-- Notes section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Notes et Observations</h6>
                </div>
                <div class="card-body">
                    {{ form.notes(class="form-control", rows="4", placeholder="Notes générales sur les contrôles d'humidité...") }}
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/validation.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeValidation('r2F1LaboForm');
    
    // Calculate average humidity for silos
    const siloHumidityInputs = [
        document.querySelector('[name="silo_humidity_1"]'),
        document.querySelector('[name="silo_humidity_2"]'),
        document.querySelector('[name="silo_humidity_3"]'),
        document.querySelector('[name="silo_humidity_4"]')
    ];
    
    const averageInput = document.querySelector('[name="humidity_after_prep"]');
    
    function calculateAverage() {
        const values = siloHumidityInputs
            .map(input => parseFloat(input.value) || 0)
            .filter(val => val > 0);
        
        if (values.length > 0) {
            const average = values.reduce((sum, val) => sum + val, 0) / values.length;
            averageInput.value = average.toFixed(2);
        }
    }
    
    siloHumidityInputs.forEach(input => {
        if (input) {
            input.addEventListener('input', calculateAverage);
        }
    });
});
</script>
{% endblock %}