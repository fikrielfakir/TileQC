{% extends "base.html" %}

{% block title %}Contrôle Argile - Céramique QC{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h3 mb-0">
                <i class="bi bi-layers text-warning"></i> Contrôle Argile (PDM Argile)
            </h1>
            {% if not form %}
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-plus-lg"></i> Ajouter Contrôle Argile
                </button>
                <ul class="dropdown-menu">
                    <li><h6 class="dropdown-header">R2-F1-LABO - Contrôles d'Humidité</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('clay.humidity_before_prep') }}">
                        <i class="bi bi-droplet text-warning"></i> Humidité Trémie Générale
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('clay.humidity_after_sieving') }}">
                        <i class="bi bi-droplet text-warning"></i> Humidité Après Tamisage
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('clay.humidity_after_prep') }}">
                        <i class="bi bi-droplet text-warning"></i> Humidité Niveau Silo
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><h6 class="dropdown-header">R2-F2-LABO - Analyse Granulométrique</h6></li>
                    <li><a class="dropdown-item" href="{{ url_for('clay.granulometry') }}">
                        <i class="bi bi-graph-up text-success"></i> Granulométrie CaCO₃
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('clay.calcium_carbonate') }}">
                        <i class="bi bi-graph-up text-success"></i> % Chaux (CaCO₃)
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{{ url_for('clay.r2_f1_labo_form') }}">
                        <i class="bi bi-file-earmark-text text-primary"></i> Fiche R2-F1-LABO Complète
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('clay.add_clay_control') }}">
                        <i class="bi bi-list-ul text-info"></i> Formulaire Simplifié
                    </a></li>
                </ul>
            </div>
            {% endif %}
        </div>
        <p class="text-muted">Surveiller les paramètres de préparation d'argile selon les spécifications R2-LABO</p>
    </div>
</div>

<!-- Sous-Contrôles Argile -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-list-check text-info"></i> Sous-Contrôles Argile</h6>
            </div>
            <div class="card-body">
                <!-- R2-F1-LABO - Contrôles d'Humidité -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="text-primary"><i class="bi bi-droplet"></i> Fiche Rapport: R2-F1-LABO - Contrôles d'Humidité</h6>
                        <p class="text-muted small">Moyens : Balance Et Etuve/Séchoir</p>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="border rounded p-3">
                            <h6 class="text-warning mb-2">1. Humidité Trémie Générale</h6>
                            <p class="small text-muted">Avant préparation</p>
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-secondary">Spéc:</span>
                                <span class="fw-bold">2.5% ≤ H ≤ 4.1%</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="border rounded p-3">
                            <h6 class="text-warning mb-2">2. Humidité Après Tamisage</h6>
                            <p class="small text-muted">Contrôle post-tamisage</p>
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-secondary">Spéc:</span>
                                <span class="fw-bold">2% ≤ H ≤ 3.5%</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="border rounded p-3">
                            <h6 class="text-warning mb-2">3. Humidité Niveau Silo</h6>
                            <p class="small text-muted">Après préparation</p>
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-secondary">Spéc:</span>
                                <span class="fw-bold">5.3% ≤ H ≤ 6.3%</span>
                            </div>
                            <small class="text-info">Méthode: R2-MA-LABO-01</small>
                        </div>
                    </div>
                </div>

                <!-- R2-F2-LABO - Analyse Granulométrique -->
                <div class="row">
                    <div class="col-12">
                        <h6 class="text-success"><i class="bi bi-graph-up"></i> Fiche Rapport: R2-F2-LABO - Analyse Granulométrique</h6>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="border rounded p-3">
                            <h6 class="text-success mb-2">4. Granulométrie CaCO₃</h6>
                            <p class="small text-muted">Moyens : Machine granulométrie</p>
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-secondary">Spéc:</span>
                                <span class="fw-bold">10% ≤ Refus ≤ 20%</span>
                            </div>
                            <small class="text-info">Méthode: R2-MA-LABO-03</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="border rounded p-3">
                            <h6 class="text-success mb-2">5. % Chaux (CaCO₃)</h6>
                            <p class="small text-muted">Moyens : Calcimètre</p>
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-secondary">Spéc:</span>
                                <span class="fw-bold">15% ≤ CaCO₃ ≤ 25%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if form %}
<!-- Add/Edit Form -->
<div class="row">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    {% if edit %}
                        <i class="bi bi-pencil"></i> Modifier l'Enregistrement de Contrôle Argile
                    {% else %}
                        <i class="bi bi-plus-lg"></i> Ajouter un Nouvel Enregistrement de Contrôle Argile
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="clayControlForm">
                    {{ form.hidden_tag() }}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.date.label(class="form-label") }}
                            {{ form.date(class="form-control") }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.shift.label(class="form-label") }}
                            {{ form.shift(class="form-control") }}
                        </div>
                    </div>
                    
                    <h6 class="text-primary border-bottom pb-2 mb-3">
                        <i class="bi bi-droplet"></i> R2-F1-LABO - Contrôles d'Humidité
                        <small class="text-muted">(Balance Et Etuve/Séchoir)</small>
                    </h6>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">
                                <strong>1. Humidité Trémie Générale</strong>
                                <small class="text-muted d-block">Avant préparation</small>
                            </label>
                            <div class="input-group">
                                {{ form.humidity_before_prep(class="form-control", **{"data-min": "2.5", "data-max": "4.1"}) }}
                                <span class="input-group-text">%</span>
                            </div>
                            <small class="text-muted">Spéc: 2.5% ≤ H ≤ 4.1%</small>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label class="form-label">
                                <strong>2. Humidité Après Tamisage</strong>
                                <small class="text-muted d-block">Contrôle post-tamisage</small>
                            </label>
                            <div class="input-group">
                                {{ form.humidity_after_sieving(class="form-control", **{"data-min": "2.0", "data-max": "3.5"}) }}
                                <span class="input-group-text">%</span>
                            </div>
                            <small class="text-muted">Spéc: 2% ≤ H ≤ 3.5%</small>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label class="form-label">
                                <strong>3. Humidité Niveau Silo</strong>
                                <small class="text-muted d-block">Après préparation</small>
                            </label>
                            <div class="input-group">
                                {{ form.humidity_after_prep(class="form-control", **{"data-min": "5.3", "data-max": "6.3"}) }}
                                <span class="input-group-text">%</span>
                            </div>
                            <small class="text-muted">Spéc: 5.3% ≤ H ≤ 6.3% (R2-MA-LABO-01)</small>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    
                    <h6 class="text-success border-bottom pb-2 mb-3">
                        <i class="bi bi-graph-up"></i> R2-F2-LABO - Analyse Granulométrique
                    </h6>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <strong>4. Granulométrie après tamis CaCO₃</strong>
                                <small class="text-muted d-block">Moyens : Machine granulométrie</small>
                            </label>
                            <div class="input-group">
                                {{ form.granulometry_refusal(class="form-control", **{"data-min": "10", "data-max": "20"}) }}
                                <span class="input-group-text">% Refus</span>
                            </div>
                            <small class="text-muted">Spéc: 10% ≤ Refus ≤ 20% (R2-MA-LABO-03)</small>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <strong>5. % Chaux (argile)</strong>
                                <small class="text-muted d-block">Moyens : Calcimètre</small>
                            </label>
                            <div class="input-group">
                                {{ form.calcium_carbonate(class="form-control", **{"data-min": "15", "data-max": "25"}) }}
                                <span class="input-group-text">% CaCO₃</span>
                            </div>
                            <small class="text-muted">Spéc: 15% ≤ CaCO₃ ≤ 25%</small>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.notes.label(class="form-label") }}
                        {{ form.notes(class="form-control", rows="3") }}
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg"></i> {% if edit %}Modifier{% else %}Enregistrer{% endif %} Contrôle
                        </button>
                        <a href="{{ url_for('clay.clay_controls') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Retour à la Liste
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-lightbulb text-warning"></i> Guidelines</h6>
            </div>
            <div class="card-body">
                <h6>Daily Measurements:</h6>
                <ul class="list-unstyled">
                    <li><i class="bi bi-check text-success"></i> Humidity before prep (1x/day)</li>
                    <li><i class="bi bi-check text-success"></i> Humidity after prep (4x/day)</li>
                </ul>
                
                <h6 class="mt-3">Mesures Hebdomadaires:</h6>
                <ul class="list-unstyled">
                    <li><i class="bi bi-check text-success"></i> Humidité après tamisage</li>
                    <li><i class="bi bi-check text-success"></i> Refus granulométrie</li>
                    <li><i class="bi bi-check text-success"></i> Carbonate de calcium</li>
                </ul>
                
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i>
                    <strong>Note:</strong> Toutes les mesures sont automatiquement validées selon les spécifications R2-LABO.
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- List View -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Enregistrements Contrôle Argile</h5>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" style="width: auto;">
                        <option>Tous Enregistrements</option>
                        <option>Aujourd'hui</option>
                        <option>Cette Semaine</option>
                        <option>Ce Mois</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                {% if controls.items %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Équipe</th>
                                <th>Humidité Avant Prép</th>
                                <th>Humidité Après Tamisage</th>
                                <th>Humidité Après Prép</th>
                                <th>Granulométrie</th>
                                <th>CaCO₃</th>
                                <th>Statut</th>
                                <th>Contrôleur</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for control in controls.items %}
                            <tr>
                                <td>{{ control.date.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    {% if control.shift %}
                                        <span class="badge bg-secondary">{{ control.shift|title }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if control.humidity_before_prep %}
                                        {{ "%.2f"|format(control.humidity_before_prep) }}%
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if control.humidity_after_sieving %}
                                        {{ "%.2f"|format(control.humidity_after_sieving) }}%
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if control.humidity_after_prep %}
                                        {{ "%.2f"|format(control.humidity_after_prep) }}%
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if control.granulometry_refusal %}
                                        {{ "%.2f"|format(control.granulometry_refusal) }}%
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if control.calcium_carbonate %}
                                        {{ "%.2f"|format(control.calcium_carbonate) }}%
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if control.compliance_status == 'compliant' %}
                                        <span class="badge bg-success">Conforme</span>
                                    {% elif control.compliance_status == 'non_compliant' %}
                                        <span class="badge bg-danger">Non-Conforme</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Partiel</span>
                                    {% endif %}
                                </td>
                                <td>{{ control.controller.full_name if control.controller else 'Inconnu' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('clay.edit_clay_control', id=control.id) }}" 
                                           class="btn btn-outline-primary">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        {% if control.humidity_before_prep and control.humidity_after_sieving and control.humidity_after_prep %}
                                        <a href="{{ url_for('clay.print_r2_f1_labo', id=control.id) }}" 
                                           class="btn btn-outline-info" title="Imprimer Fiche R2-F1-LABO">
                                            <i class="bi bi-printer"></i>
                                        </a>
                                        {% endif %}
                                        {% if current_user.role in ['admin', 'quality_manager'] %}
                                        <form method="POST" action="{{ url_for('clay.delete_clay_control', id=control.id) }}" 
                                              style="display: inline;" onsubmit="return confirm('Are you sure?')">
                                            <button type="submit" class="btn btn-outline-danger">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if controls.pages > 1 %}
                <nav aria-label="Clay controls pagination">
                    <ul class="pagination justify-content-center">
                        {% if controls.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('clay.clay_controls', page=controls.prev_num) }}">Previous</a>
                            </li>
                        {% endif %}
                        
                        {% for page_num in controls.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != controls.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('clay.clay_controls', page=page_num) }}">{{ page_num }}</a>
                                    </li>
                                {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                {% endif %}
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if controls.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('clay.clay_controls', page=controls.next_num) }}">Next</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
                
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-clipboard text-muted display-4"></i>
                    <h5 class="text-muted mt-3">No clay control records found</h5>
                    <p class="text-muted">Start by adding your first clay control measurement.</p>
                    <a href="{{ url_for('clay.add_clay_control') }}" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i> Add First Record
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/validation.js') }}"></script>
<script>
// Initialize clay control validation
document.addEventListener('DOMContentLoaded', function() {
    initializeValidation('clayControlForm');
});
</script>
{% endblock %}
