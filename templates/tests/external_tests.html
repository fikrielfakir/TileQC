{% extends "base.html" %}

{% block title %}External Tests - Ceramic QC{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h3 mb-0">
                <i class="bi bi-building text-info"></i> External Laboratory Tests
            </h1>
            {% if not form %}
            <a href="{{ url_for('tests.add_external_test') }}" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i> Add External Test
            </a>
            {% endif %}
        </div>
        <p class="text-muted">CETEMCO laboratory test results and certifications</p>
    </div>
</div>

<!-- Test Types Reference -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-info-circle text-info"></i> External Test Types</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <strong>Thermal Shock Resistance:</strong>
                        <ul class="list-unstyled mt-2">
                            <li><span class="badge bg-primary">Standard:</span> ISO 10545-11V2000</li>
                            <li><span class="badge bg-info">Laboratory:</span> CETEMCO</li>
                            <li><span class="badge bg-secondary">Result:</span> Pass/Fail certification</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <strong>Chemical Resistance:</strong>
                        <ul class="list-unstyled mt-2">
                            <li><span class="badge bg-success">Standard:</span> ISO 10545-13V2017</li>
                            <li><span class="badge bg-info">Laboratory:</span> CETEMCO</li>
                            <li><span class="badge bg-secondary">Scope:</span> Acids, bases, household chemicals</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <strong>Stain Resistance:</strong>
                        <ul class="list-unstyled mt-2">
                            <li><span class="badge bg-warning">Standard:</span> ISO 10545-14V2017</li>
                            <li><span class="badge bg-info">Laboratory:</span> CETEMCO</li>
                            <li><span class="badge bg-secondary">Classification:</span> Class 1-5 rating</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if form %}
<!-- Add/Edit Form -->
<div class="row">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    {% if edit %}
                        <i class="bi bi-pencil"></i> Edit External Test Record
                    {% else %}
                        <i class="bi bi-plus-lg"></i> Add New External Test Record
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="externalTestForm">
                    {{ form.hidden_tag() }}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.date.label(class="form-label") }}
                            {{ form.date(class="form-control") }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.test_type.label(class="form-label") }}
                            {{ form.test_type(class="form-control", id="testType") }}
                        </div>
                    </div>
                    
                    <h6 class="text-muted border-bottom pb-2 mb-3">Test Details</h6>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.iso_standard.label(class="form-label") }}
                            {{ form.iso_standard(class="form-control", id="isoStandard") }}
                            <small class="text-muted" id="standardHelp">ISO standard reference</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.laboratory.label(class="form-label") }}
                            {{ form.laboratory(class="form-control") }}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.test_report_number.label(class="form-label") }}
                            {{ form.test_report_number(class="form-control") }}
                            <small class="text-muted">Laboratory report reference number</small>
                        </div>
                    </div>
                    
                    <h6 class="text-muted border-bottom pb-2 mb-3">Test Results</h6>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.result_status.label(class="form-label") }}
                            {{ form.result_status(class="form-control", id="resultStatus") }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.result_value.label(class="form-label") }}
                            {{ form.result_value(class="form-control") }}
                            <small class="text-muted" id="valueHelp">Numeric result if applicable</small>
                        </div>
                    </div>
                    
                    <!-- Result Status Indicator -->
                    <div class="row">
                        <div class="col-12 mb-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">Test Status</h6>
                                    <div id="testStatusIndicator" class="alert alert-secondary">
                                        <i class="bi bi-info-circle"></i> Select test result status to see details
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.notes.label(class="form-label") }}
                        {{ form.notes(class="form-control", rows="4", placeholder="Additional test details, conditions, observations, or corrective actions...") }}
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg"></i> {% if edit %}Update{% else %}Save{% endif %} Record
                        </button>
                        <a href="{{ url_for('tests.external_tests') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Back to List
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-lightbulb text-warning"></i> External Testing Guidelines</h6>
            </div>
            <div class="card-body">
                <h6>CETEMCO Laboratory:</h6>
                <ul class="list-unstyled">
                    <li><i class="bi bi-building text-info"></i> Accredited testing facility</li>
                    <li><i class="bi bi-award text-info"></i> ISO standard compliance</li>
                    <li><i class="bi bi-file-earmark-check text-info"></i> Official certifications</li>
                </ul>
                
                <h6 class="mt-3">Test Scheduling:</h6>
                <ul class="list-unstyled">
                    <li><i class="bi bi-calendar text-warning"></i> Periodic testing required</li>
                    <li><i class="bi bi-clock text-warning"></i> Results typically 2-3 weeks</li>
                    <li><i class="bi bi-file-text text-warning"></i> Official reports required for certification</li>
                </ul>
                
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i>
                    <strong>Important:</strong> External test results are required for product certification and compliance.
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- List View -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">External Test Records</h5>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" style="width: auto;" 
                            onchange="window.location.href='{{ url_for('tests.external_tests') }}?test_type=' + this.value">
                        <option value="">All Test Types</option>
                        <option value="thermal_shock" {{ 'selected' if test_filter == 'thermal_shock' }}>Thermal Shock Resistance</option>
                        <option value="chemical_resistance" {{ 'selected' if test_filter == 'chemical_resistance' }}>Chemical Resistance</option>
                        <option value="stain_resistance" {{ 'selected' if test_filter == 'stain_resistance' }}>Stain Resistance</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                {% if tests.items %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Test Type</th>
                                <th>ISO Standard</th>
                                <th>Report Number</th>
                                <th>Result</th>
                                <th>Laboratory</th>
                                <th>Controller</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for test in tests.items %}
                            <tr>
                                <td>{{ test.date.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    {% if test.test_type == 'thermal_shock' %}
                                        <span class="badge bg-primary">Thermal Shock</span>
                                    {% elif test.test_type == 'chemical_resistance' %}
                                        <span class="badge bg-success">Chemical Resistance</span>
                                    {% elif test.test_type == 'stain_resistance' %}
                                        <span class="badge bg-warning">Stain Resistance</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ test.test_type|title }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if test.iso_standard %}
                                        <code>{{ test.iso_standard }}</code>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if test.test_report_number %}
                                        <small class="font-monospace">{{ test.test_report_number }}</small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if test.result_status == 'pass' %}
                                        <span class="badge bg-success">Pass</span>
                                    {% elif test.result_status == 'fail' %}
                                        <span class="badge bg-danger">Fail</span>
                                    {% elif test.result_status == 'pending' %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ test.result_status|title }}</span>
                                    {% endif %}
                                    {% if test.result_value %}
                                        <br><small>{{ test.result_value }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ test.laboratory or 'CETEMCO' }}</td>
                                <td>{{ test.controller.full_name if test.controller else 'Unknown' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('tests.edit_external_test', id=test.id) }}" 
                                           class="btn btn-outline-primary">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        {% if current_user.role in ['admin', 'quality_manager'] %}
                                        <button type="button" class="btn btn-outline-danger" 
                                                onclick="confirmDelete({{ test.id }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-building text-muted display-4"></i>
                    <h5 class="text-muted mt-3">No external test records found</h5>
                    <p class="text-muted">Start by adding your first external laboratory test result.</p>
                    <a href="{{ url_for('tests.add_external_test') }}" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i> Add First Record
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/validation.js') }}"></script>
<script>
// Test type specifications
const testSpecs = {
    'thermal_shock': {
        standard: 'ISO 10545-11V2000',
        description: 'Thermal shock resistance testing'
    },
    'chemical_resistance': {
        standard: 'ISO 10545-13V2017',
        description: 'Chemical resistance testing'
    },
    'stain_resistance': {
        standard: 'ISO 10545-14V2017',
        description: 'Stain resistance testing'
    }
};

document.addEventListener('DOMContentLoaded', function() {
    initializeValidation('externalTestForm');
    
    const testTypeSelect = document.getElementById('testType');
    const isoStandardInput = document.getElementById('isoStandard');
    const standardHelp = document.getElementById('standardHelp');
    const resultStatusSelect = document.getElementById('resultStatus');
    const testStatusIndicator = document.getElementById('testStatusIndicator');
    const valueHelp = document.getElementById('valueHelp');
    
    // Auto-fill ISO standard based on test type
    if (testTypeSelect && isoStandardInput) {
        testTypeSelect.addEventListener('change', function() {
            const testType = this.value;
            if (testType && testSpecs[testType]) {
                const spec = testSpecs[testType];
                isoStandardInput.value = spec.standard;
                standardHelp.textContent = spec.description;
                
                // Update value help text
                if (testType === 'stain_resistance') {
                    valueHelp.textContent = 'Classification (1-5) if applicable';
                } else {
                    valueHelp.textContent = 'Numeric result if applicable';
                }
            } else {
                standardHelp.textContent = 'ISO standard reference';
                valueHelp.textContent = 'Numeric result if applicable';
            }
        });
        
        // Trigger change event if test type is already selected
        if (testTypeSelect.value) {
            testTypeSelect.dispatchEvent(new Event('change'));
        }
    }
    
    // Update status indicator based on result
    if (resultStatusSelect && testStatusIndicator) {
        resultStatusSelect.addEventListener('change', function() {
            const status = this.value;
            
            switch (status) {
                case 'pass':
                    testStatusIndicator.className = 'alert alert-success';
                    testStatusIndicator.innerHTML = '<i class="bi bi-check-circle"></i> <strong>Test Passed</strong> - Product meets requirements';
                    break;
                case 'fail':
                    testStatusIndicator.className = 'alert alert-danger';
                    testStatusIndicator.innerHTML = '<i class="bi bi-x-circle"></i> <strong>Test Failed</strong> - Product does not meet requirements - corrective action required';
                    break;
                case 'pending':
                    testStatusIndicator.className = 'alert alert-warning';
                    testStatusIndicator.innerHTML = '<i class="bi bi-clock"></i> <strong>Test Pending</strong> - Awaiting laboratory results';
                    break;
                default:
                    testStatusIndicator.className = 'alert alert-secondary';
                    testStatusIndicator.innerHTML = '<i class="bi bi-info-circle"></i> Select test result status to see details';
                    break;
            }
        });
        
        // Trigger change event if status is already selected
        if (resultStatusSelect.value) {
            resultStatusSelect.dispatchEvent(new Event('change'));
        }
    }
});

function confirmDelete(id) {
    if (confirm('Are you sure you want to delete this external test record?')) {
        fetch(`/tests/external/delete/${id}`, {method: 'POST'})
            .then(() => location.reload());
    }
}
</script>
{% endblock %}
