{% extends "base.html" %}

{% block title %}Tests Externes - Ceramic QC{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h3 mb-0">
                <i class="bi bi-building text-info"></i> Tests de Laboratoire Externes
            </h1>
            {% if not form %}
            <a href="{{ url_for('tests.add_external_test') }}" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i> Ajouter Test Externe
            </a>
            {% endif %}
        </div>
        <p class="text-muted">Résultats de tests et certifications du laboratoire CETEMCO</p>
    </div>
</div>

<!-- Test Types Reference -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-info-circle text-info"></i> Types de Tests Externes</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <strong>Résistance au Choc Thermique:</strong>
                        <ul class="list-unstyled mt-2">
                            <li><span class="badge bg-primary">Norme:</span> ISO 10545-11V2000</li>
                            <li><span class="badge bg-info">Laboratoire:</span> CETEMCO</li>
                            <li><span class="badge bg-secondary">Résultat:</span> Certification Réussi/Échoué</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <strong>Résistance Chimique:</strong>
                        <ul class="list-unstyled mt-2">
                            <li><span class="badge bg-success">Norme:</span> ISO 10545-13V2017</li>
                            <li><span class="badge bg-info">Laboratoire:</span> CETEMCO</li>
                            <li><span class="badge bg-secondary">Portée:</span> Acides, bases, produits chimiques ménagers</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <strong>Résistance aux Taches:</strong>
                        <ul class="list-unstyled mt-2">
                            <li><span class="badge bg-warning">Norme:</span> ISO 10545-14V2017</li>
                            <li><span class="badge bg-info">Laboratoire:</span> CETEMCO</li>
                            <li><span class="badge bg-secondary">Classification:</span> Classement 1-5</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if form %}
<!-- Add/Edit Form -->
<div class="row">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    {% if edit %}
                        <i class="bi bi-pencil"></i> Modifier Enregistrement Test Externe
                    {% else %}
                        <i class="bi bi-plus-lg"></i> Ajouter Nouvel Enregistrement Test Externe
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="externalTestForm">
                    {{ form.hidden_tag() }}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.date.label(class="form-label") }}
                            {{ form.date(class="form-control") }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.test_type.label(class="form-label") }}
                            {{ form.test_type(class="form-control", id="testType") }}
                        </div>
                    </div>
                    
                    <h6 class="text-muted border-bottom pb-2 mb-3">Détails du Test</h6>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.iso_standard.label(class="form-label") }}
                            {{ form.iso_standard(class="form-control", id="isoStandard") }}
                            <small class="text-muted" id="standardHelp">Référence norme ISO</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.laboratory.label(class="form-label") }}
                            {{ form.laboratory(class="form-control") }}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.test_report_number.label(class="form-label") }}
                            {{ form.test_report_number(class="form-control") }}
                            <small class="text-muted">Numéro de référence rapport laboratoire</small>
                        </div>
                    </div>
                    
                    <h6 class="text-muted border-bottom pb-2 mb-3">Résultats du Test</h6>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.result_status.label(class="form-label") }}
                            {{ form.result_status(class="form-control", id="resultStatus") }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.result_value.label(class="form-label") }}
                            {{ form.result_value(class="form-control") }}
                            <small class="text-muted" id="valueHelp">Résultat numérique si applicable</small>
                        </div>
                    </div>
                    
                    <!-- Result Status Indicator -->
                    <div class="row">
                        <div class="col-12 mb-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">Statut du Test</h6>
                                    <div id="testStatusIndicator" class="alert alert-secondary">
                                        <i class="bi bi-info-circle"></i> Sélectionnez le statut du résultat pour voir les détails
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.notes.label(class="form-label") }}
                        {{ form.notes(class="form-control", rows="4", placeholder="Détails supplémentaires du test, conditions, observations, ou actions correctives...") }}
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg"></i> {% if edit %}Modifier{% else %}Enregistrer{% endif %} Contrôle
                        </button>
                        <a href="{{ url_for('tests.external_tests') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Retour à la Liste
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-lightbulb text-warning"></i> Directives Tests Externes</h6>
            </div>
            <div class="card-body">
                <h6>CETEMCO Laboratoire:</h6>
                <ul class="list-unstyled">
                    <li><i class="bi bi-building text-info"></i> Installation de test accréditée</li>
                    <li><i class="bi bi-award text-info"></i> Conformité aux normes ISO</li>
                    <li><i class="bi bi-file-earmark-check text-info"></i> Certifications officielles</li>
                </ul>
                
                <h6 class="mt-3">Planification Tests:</h6>
                <ul class="list-unstyled">
                    <li><i class="bi bi-calendar text-warning"></i> Tests périodiques requis</li>
                    <li><i class="bi bi-clock text-warning"></i> Résultats typiquement 2-3 semaines</li>
                    <li><i class="bi bi-file-text text-warning"></i> Rapports officiels requis pour certification</li>
                </ul>
                
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i>
                    <strong>Important:</strong> Les résultats de tests externes sont requis pour la certification produit et la conformité.
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- List View -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Enregistrements Tests Externes</h5>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" style="width: auto;" 
                            onchange="window.location.href='{{ url_for('tests.external_tests') }}?test_type=' + this.value">
                        <option value="">Tous Types de Tests</option>
                        <option value="thermal_shock" {{ 'selected' if test_filter == 'thermal_shock' }}>Résistance Choc Thermique</option>
                        <option value="chemical_resistance" {{ 'selected' if test_filter == 'chemical_resistance' }}>Résistance Chimique</option>
                        <option value="stain_resistance" {{ 'selected' if test_filter == 'stain_resistance' }}>Résistance aux Taches</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                {% if tests.items %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type Test</th>
                                <th>Norme ISO</th>
                                <th>N° Rapport</th>
                                <th>Résultat</th>
                                <th>Laboratoire</th>
                                <th>Contrôleur</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for test in tests.items %}
                            <tr>
                                <td>{{ test.date.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    {% if test.test_type == 'thermal_shock' %}
                                        <span class="badge bg-primary">Choc Thermique</span>
                                    {% elif test.test_type == 'chemical_resistance' %}
                                        <span class="badge bg-success">Résistance Chimique</span>
                                    {% elif test.test_type == 'stain_resistance' %}
                                        <span class="badge bg-warning">Résistance Taches</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ test.test_type|title }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if test.iso_standard %}
                                        <code>{{ test.iso_standard }}</code>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if test.test_report_number %}
                                        <small class="font-monospace">{{ test.test_report_number }}</small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if test.result_status == 'pass' %}
                                        <span class="badge bg-success">Réussi</span>
                                    {% elif test.result_status == 'fail' %}
                                        <span class="badge bg-danger">Échoué</span>
                                    {% elif test.result_status == 'pending' %}
                                        <span class="badge bg-warning">En Attente</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ test.result_status|title }}</span>
                                    {% endif %}
                                    {% if test.result_value %}
                                        <br><small>{{ test.result_value }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ test.laboratory or 'CETEMCO' }}</td>
                                <td>{{ test.controller.full_name if test.controller else 'Inconnu' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('tests.edit_external_test', id=test.id) }}" 
                                           class="btn btn-outline-primary">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        {% if current_user.role in ['admin', 'quality_manager'] %}
                                        <button type="button" class="btn btn-outline-danger" 
                                                onclick="confirmDelete({{ test.id }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-building text-muted display-4"></i>
                    <h5 class="text-muted mt-3">Aucun enregistrement de test externe trouvé</h5>
                    <p class="text-muted">Commencez par ajouter votre premier résultat de test de laboratoire externe.</p>
                    <a href="{{ url_for('tests.add_external_test') }}" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i> Ajouter Premier Enregistrement
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/validation.js') }}"></script>
<script>
// Test type specifications
const testSpecs = {
    'thermal_shock': {
        standard: 'ISO 10545-11V2000',
        description: 'Test de résistance au choc thermique'
    },
    'chemical_resistance': {
        standard: 'ISO 10545-13V2017',
        description: 'Test de résistance chimique'
    },
    'stain_resistance': {
        standard: 'ISO 10545-14V2017',
        description: 'Test de résistance aux taches'
    }
};

document.addEventListener('DOMContentLoaded', function() {
    initializeValidation('externalTestForm');
    
    const testTypeSelect = document.getElementById('testType');
    const isoStandardInput = document.getElementById('isoStandard');
    const standardHelp = document.getElementById('standardHelp');
    const resultStatusSelect = document.getElementById('resultStatus');
    const testStatusIndicator = document.getElementById('testStatusIndicator');
    const valueHelp = document.getElementById('valueHelp');
    
    // Auto-fill ISO standard based on test type
    if (testTypeSelect && isoStandardInput) {
        testTypeSelect.addEventListener('change', function() {
            const testType = this.value;
            if (testType && testSpecs[testType]) {
                const spec = testSpecs[testType];
                isoStandardInput.value = spec.standard;
                standardHelp.textContent = spec.description;
                
                // Update value help text
                if (testType === 'stain_resistance') {
                    valueHelp.textContent = 'Classification (1-5) si applicable';
                } else {
                    valueHelp.textContent = 'Résultat numérique si applicable';
                }
            } else {
                standardHelp.textContent = 'Référence norme ISO';
                valueHelp.textContent = 'Résultat numérique si applicable';
            }
        });
        
        // Trigger change event if test type is already selected
        if (testTypeSelect.value) {
            testTypeSelect.dispatchEvent(new Event('change'));
        }
    }
    
    // Update status indicator based on result
    if (resultStatusSelect && testStatusIndicator) {
        resultStatusSelect.addEventListener('change', function() {
            const status = this.value;
            
            switch (status) {
                case 'pass':
                    testStatusIndicator.className = 'alert alert-success';
                    testStatusIndicator.innerHTML = '<i class="bi bi-check-circle"></i> <strong>Test Réussi</strong> - Le produit répond aux exigences';
                    break;
                case 'fail':
                    testStatusIndicator.className = 'alert alert-danger';
                    testStatusIndicator.innerHTML = '<i class="bi bi-x-circle"></i> <strong>Test Échoué</strong> - Le produit ne répond pas aux exigences - action corrective requise';
                    break;
                case 'pending':
                    testStatusIndicator.className = 'alert alert-warning';
                    testStatusIndicator.innerHTML = '<i class="bi bi-clock"></i> <strong>Test En Attente</strong> - En attente des résultats du laboratoire';
                    break;
                default:
                    testStatusIndicator.className = 'alert alert-secondary';
                    testStatusIndicator.innerHTML = '<i class="bi bi-info-circle"></i> Sélectionnez le statut du résultat pour voir les détails';
                    break;
            }
        });
        
        // Trigger change event if status is already selected
        if (resultStatusSelect.value) {
            resultStatusSelect.dispatchEvent(new Event('change'));
        }
    }
});

function confirmDelete(id) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cet enregistrement de test externe ?')) {
        fetch(`/tests/external/delete/${id}`, {method: 'POST'})
            .then(() => location.reload());
    }
}
</script>
{% endblock %}
