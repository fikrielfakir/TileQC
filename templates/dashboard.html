{% extends "base.html" %}

{% block title %}Dashboard - Ceramic QC{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3">
            <div class="flex-grow-1">
                <h1 class="h2 mb-2 d-flex align-items-center">
                    <i class="bi bi-speedometer2 text-primary me-3" aria-hidden="true"></i> 
                    <span>Quality Control Dashboard</span>
                </h1>
                <p class="text-muted mb-0">Real-time production monitoring and compliance tracking</p>
            </div>
            <div class="d-flex flex-column flex-sm-row gap-3 align-items-stretch align-items-sm-center">
                <div class="d-flex align-items-center gap-2">
                    <label for="dateFilter" class="form-label mb-0 text-nowrap fw-semibold">Filter Date:</label>
                    <input type="date" id="dateFilter" class="form-control" value="{{ selected_date }}" 
                           onchange="updateDashboard(this.value)" 
                           style="min-width: 150px;">
                </div>
                <button class="btn btn-outline-primary" onclick="refreshDashboard()" aria-label="Refresh dashboard">
                    <i class="bi bi-arrow-clockwise" aria-hidden="true"></i>
                    <span class="d-none d-sm-inline ms-1">Refresh</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Overall Statistics Cards -->
<div class="row mb-4 g-3">
    <div class="col-lg-3 col-md-6">
        <div class="stats-card">
            <div class="stats-icon bg-primary text-white">
                <i class="bi bi-check-circle-fill" aria-hidden="true"></i>
            </div>
            <div class="stats-content">
                <h6 class="stats-title mb-1">Overall Compliance</h6>
                <div class="stats-value text-primary">{{ stats.overall.compliance_rate }}%</div>
                <p class="stats-subtitle mb-0">{{ stats.overall.compliant }}/{{ stats.overall.total }} tests passed</p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="stats-card">
            <div class="stats-icon" style="background: linear-gradient(135deg, var(--success-color), #20c997);">
                <i class="bi bi-check2-all text-white" aria-hidden="true"></i>
            </div>
            <div class="stats-content">
                <h6 class="stats-title mb-1">Compliant Tests</h6>
                <div class="stats-value text-success">{{ stats.overall.compliant }}</div>
                <p class="stats-subtitle mb-0">Today's passing tests</p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="stats-card">
            <div class="stats-icon" style="background: linear-gradient(135deg, var(--danger-color), #e35d6a);">
                <i class="bi bi-x-circle-fill text-white" aria-hidden="true"></i>
            </div>
            <div class="stats-content">
                <h6 class="stats-title mb-1">Non-Compliant</h6>
                <div class="stats-value text-danger">{{ stats.overall.non_compliant }}</div>
                <p class="stats-subtitle mb-0">Requiring attention</p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="stats-card">
            <div class="stats-icon" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-light));">
                <i class="bi bi-clipboard-data text-white" aria-hidden="true"></i>
            </div>
            <div class="stats-content">
                <h6 class="stats-title mb-1">Total Tests</h6>
                <div class="stats-value" style="color: var(--primary-color);">{{ stats.overall.total }}</div>
                <p class="stats-subtitle mb-0">All production stages</p>
            </div>
        </div>
    </div>
</div>

<!-- Production Stages and Charts Row -->
<div class="row g-4">
    <!-- Production Stage Status -->
    <div class="col-xl-8 col-lg-7">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title d-flex align-items-center mb-0">
                    <i class="bi bi-factory text-primary me-2" aria-hidden="true"></i>
                    Production Stage Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Clay Control -->
                    <div class="col-xl-6 col-md-6">
                        <div class="stage-card">
                            <div class="stage-header">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 d-flex align-items-center">
                                        <i class="bi bi-layers text-warning me-2" aria-hidden="true"></i>Clay Control
                                    </h6>
                                    <small class="stage-subtitle">PDM Argile</small>
                                </div>
                                <div class="stage-stats">
                                    <span class="badge bg-{{ 'success' if ((stats.clay.compliant / stats.clay.total * 100) if stats.clay.total > 0 else 0) > 95 else 'warning' if ((stats.clay.compliant / stats.clay.total * 100) if stats.clay.total > 0 else 0) > 80 else 'danger' }}">
                                        {{ "%.1f"|format((stats.clay.compliant / stats.clay.total * 100) if stats.clay.total > 0 else 0) }}%
                                    </span>
                                    <small class="text-muted">{{ stats.clay.compliant }}/{{ stats.clay.total }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Press Control -->
                    <div class="col-xl-6 col-md-6">
                        <div class="stage-card">
                            <div class="stage-header">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 d-flex align-items-center">
                                        <i class="bi bi-hammer text-info me-2" aria-hidden="true"></i>Press Control
                                    </h6>
                                    <small class="stage-subtitle">Format & Defects</small>
                                </div>
                                <div class="stage-stats">
                                    <span class="badge bg-{{ 'success' if ((stats.press.compliant / stats.press.total * 100) if stats.press.total > 0 else 0) > 95 else 'warning' if ((stats.press.compliant / stats.press.total * 100) if stats.press.total > 0 else 0) > 80 else 'danger' }}">
                                        {{ "%.1f"|format((stats.press.compliant / stats.press.total * 100) if stats.press.total > 0 else 0) }}%
                                    </span>
                                    <small class="text-muted">{{ stats.press.compliant }}/{{ stats.press.total }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dryer Control -->
                    <div class="col-xl-6 col-md-6">
                        <div class="stage-card">
                            <div class="stage-header">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 d-flex align-items-center">
                                        <i class="bi bi-thermometer-sun text-orange me-2" aria-hidden="true"></i>Dryer Control
                                    </h6>
                                    <small class="stage-subtitle">SÃ©choir</small>
                                </div>
                                <div class="stage-stats">
                                    <span class="badge bg-{{ 'success' if ((stats.dryer.compliant / stats.dryer.total * 100) if stats.dryer.total > 0 else 0) > 95 else 'warning' if ((stats.dryer.compliant / stats.dryer.total * 100) if stats.dryer.total > 0 else 0) > 80 else 'danger' }}">
                                        {{ "%.1f"|format((stats.dryer.compliant / stats.dryer.total * 100) if stats.dryer.total > 0 else 0) }}%
                                    </span>
                                    <small class="text-muted">{{ stats.dryer.compliant }}/{{ stats.dryer.total }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Biscuit Kiln -->
                    <div class="col-xl-6 col-md-6">
                        <div class="stage-card">
                            <div class="stage-header">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 d-flex align-items-center">
                                        <i class="bi bi-fire text-danger me-2" aria-hidden="true"></i>Biscuit Kiln
                                    </h6>
                                    <small class="stage-subtitle">Four Biscuit</small>
                                </div>
                                <div class="stage-stats">
                                    <span class="badge bg-{{ 'success' if ((stats.biscuit_kiln.compliant / stats.biscuit_kiln.total * 100) if stats.biscuit_kiln.total > 0 else 0) > 95 else 'warning' if ((stats.biscuit_kiln.compliant / stats.biscuit_kiln.total * 100) if stats.biscuit_kiln.total > 0 else 0) > 80 else 'danger' }}">
                                        {{ "%.1f"|format((stats.biscuit_kiln.compliant / stats.biscuit_kiln.total * 100) if stats.biscuit_kiln.total > 0 else 0) }}%
                                    </span>
                                    <small class="text-muted">{{ stats.biscuit_kiln.compliant }}/{{ stats.biscuit_kiln.total }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Email Kiln -->
                    <div class="col-xl-6 col-md-6">
                        <div class="stage-card">
                            <div class="stage-header">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 d-flex align-items-center">
                                        <i class="bi bi-fire text-primary me-2" aria-hidden="true"></i>Email Kiln
                                    </h6>
                                    <small class="stage-subtitle">Four Email</small>
                                </div>
                                <div class="stage-stats">
                                    <span class="badge bg-{{ 'success' if ((stats.email_kiln.compliant / stats.email_kiln.total * 100) if stats.email_kiln.total > 0 else 0) > 95 else 'warning' if ((stats.email_kiln.compliant / stats.email_kiln.total * 100) if stats.email_kiln.total > 0 else 0) > 80 else 'danger' }}">
                                        {{ "%.1f"|format((stats.email_kiln.compliant / stats.email_kiln.total * 100) if stats.email_kiln.total > 0 else 0) }}%
                                    </span>
                                    <small class="text-muted">{{ stats.email_kiln.compliant }}/{{ stats.email_kiln.total }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enamel Control -->
                    <div class="col-xl-6 col-md-6">
                        <div class="stage-card">
                            <div class="stage-header">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 d-flex align-items-center">
                                        <i class="bi bi-palette text-secondary me-2" aria-hidden="true"></i>Enamel Control
                                    </h6>
                                    <small class="stage-subtitle">PDE & Production</small>
                                </div>
                                <div class="stage-stats">
                                    <span class="badge bg-{{ 'success' if ((stats.enamel.compliant / stats.enamel.total * 100) if stats.enamel.total > 0 else 0) > 95 else 'warning' if ((stats.enamel.compliant / stats.enamel.total * 100) if stats.enamel.total > 0 else 0) > 80 else 'danger' }}">
                                        {{ "%.1f"|format((stats.enamel.compliant / stats.enamel.total * 100) if stats.enamel.total > 0 else 0) }}%
                                    </span>
                                    <small class="text-muted">{{ stats.enamel.compliant }}/{{ stats.enamel.total }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Non-Conformities -->
    <div class="col-xl-4 col-lg-5">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title d-flex align-items-center mb-0">
                    <i class="bi bi-exclamation-triangle text-warning me-2" aria-hidden="true"></i>
                    Recent Non-Conformities
                </h5>
            </div>
            <div class="card-body">
                {% if recent_nc %}
                    <div class="list-group list-group-flush">
                        {% for nc in recent_nc[:6] %}
                        <div class="list-group-item border-0 px-0 py-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="me-auto">
                                    <h6 class="mb-1 fw-semibold">{{ nc.type }}</h6>
                                    <p class="mb-1 small text-muted">{{ nc.controller }}</p>
                                    <small class="text-muted">{{ nc.date.strftime('%Y-%m-%d') }}</small>
                                </div>
                                <span class="badge bg-danger ms-2 flex-shrink-0">{{ nc.status }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if recent_nc|length > 6 %}
                    <div class="text-center mt-3">
                        <a href="{{ url_for('reports.non_conformities') }}" class="btn btn-outline-primary btn-sm">
                            View All Non-Conformities
                        </a>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-check-circle text-success display-4 mb-3"></i>
                        <h6 class="text-success">No Recent Non-Conformities</h6>
                        <p class="text-muted small">All recent tests are compliant</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Trend Chart Row -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title d-flex align-items-center mb-0">
                    <i class="bi bi-graph-up text-primary me-2" aria-hidden="true"></i>
                    Weekly Compliance Trend
                </h5>
            </div>
            <div class="card-body">
                <div class="position-relative" style="height: 300px;">
                    <canvas id="trendChart" class="w-100 h-100"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title d-flex align-items-center mb-0">
                    <i class="bi bi-lightning-charge text-primary me-2" aria-hidden="true"></i>
                    Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-lg-2 col-md-3 col-sm-6">
                        <a href="{{ url_for('clay.add_clay_control') }}" class="btn btn-outline-primary w-100 h-100">
                            <i class="bi bi-layers d-block fs-1 mb-2" aria-hidden="true"></i>
                            <span class="small">Add Clay Control</span>
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-3 col-sm-6">
                        <a href="{{ url_for('press.add_press_control') }}" class="btn btn-outline-primary w-100 h-100">
                            <i class="bi bi-hammer d-block fs-1 mb-2" aria-hidden="true"></i>
                            <span class="small">Add Press Control</span>
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-3 col-sm-6">
                        <a href="{{ url_for('dryer.add_dryer_control') }}" class="btn btn-outline-primary w-100 h-100">
                            <i class="bi bi-thermometer-sun d-block fs-1 mb-2" aria-hidden="true"></i>
                            <span class="small">Add Dryer Control</span>
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-3 col-sm-6">
                        <a href="{{ url_for('kilns.add_biscuit_control') }}" class="btn btn-outline-primary w-100 h-100">
                            <i class="bi bi-fire d-block fs-1 mb-2" aria-hidden="true"></i>
                            <span class="small">Add Kiln Control</span>
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-3 col-sm-6">
                        <a href="{{ url_for('enamel.add_enamel_control') }}" class="btn btn-outline-primary w-100 h-100">
                            <i class="bi bi-palette d-block fs-1 mb-2" aria-hidden="true"></i>
                            <span class="small">Add Enamel Control</span>
                        </a>
                    </div>
                    <div class="col-lg-2 col-md-3 col-sm-6">
                        <a href="{{ url_for('reports.daily_report') }}" class="btn btn-outline-secondary w-100 h-100">
                            <i class="bi bi-file-earmark-text d-block fs-1 mb-2" aria-hidden="true"></i>
                            <span class="small">Daily Report</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dashboard functionality
let trendChart;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeTrendChart();
    setInterval(refreshDashboard, 300000); // Auto-refresh every 5 minutes
});

// Initialize trend chart
function initializeTrendChart() {
    const trendData = {{ trend_data|safe }};
    const ctx = document.getElementById('trendChart');
    
    if (!ctx) return;
    
    // Destroy existing chart if it exists
    if (trendChart) {
        trendChart.destroy();
    }
    
    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: trendData.map(d => {
                const date = new Date(d.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }),
            datasets: [{
                label: 'Compliance Rate',
                data: trendData.map(d => d.compliance_rate),
                borderColor: '#003d9d',
                backgroundColor: 'rgba(0, 61, 157, 0.1)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#003d9d',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8,
                pointHoverBackgroundColor: '#003d9d',
                pointHoverBorderColor: '#ffffff',
                pointHoverBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 61, 157, 0.9)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: '#003d9d',
                    borderWidth: 1,
                    cornerRadius: 8,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            return 'Compliance: ' + context.parsed.y + '%';
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#6c757d',
                        padding: 10
                    }
                },
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        color: '#6c757d',
                        padding: 10,
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            },
            elements: {
                point: {
                    hoverRadius: 8
                }
            }
        }
    });
}

// Update dashboard with selected date
function updateDashboard(selectedDate) {
    showLoadingOverlay();
    window.location.href = `/?date=${selectedDate}`;
}

// Refresh dashboard
async function refreshDashboard() {
    const refreshBtn = document.querySelector('button[onclick="refreshDashboard()"]');
    const icon = refreshBtn.querySelector('i');
    
    // Add spinning animation
    icon.classList.add('rotating');
    refreshBtn.disabled = true;
    
    try {
        const response = await fetch(`/api/dashboard/refresh?date=${document.getElementById('dateFilter').value}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            updateDashboardData(data);
        } else {
            console.error('Error refreshing dashboard:', response.statusText);
            location.reload(); // Fallback to full refresh
        }
    } catch (error) {
        console.error('Error refreshing dashboard:', error);
        location.reload(); // Fallback to full refresh
    } finally {
        // Remove spinning animation
        setTimeout(() => {
            icon.classList.remove('rotating');
            refreshBtn.disabled = false;
        }, 1000);
    }
}

// Update dashboard data (if API exists)
function updateDashboardData(data) {
    // Update statistics
    if (data.stats) {
        document.querySelector('.stats-value.text-primary').textContent = data.stats.overall.compliance_rate + '%';
        document.querySelector('.stats-value.text-success').textContent = data.stats.overall.compliant;
        document.querySelector('.stats-value.text-danger').textContent = data.stats.overall.non_compliant;
        document.querySelector('.stats-value[style*="primary-color"]').textContent = data.stats.overall.total;
    }
    
    // Update chart if trend data is provided
    if (data.trend_data && trendChart) {
        trendChart.data.labels = data.trend_data.map(d => {
            const date = new Date(d.date);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        trendChart.data.datasets[0].data = data.trend_data.map(d => d.compliance_rate);
        trendChart.update('active');
    }
}

// Show loading overlay
function showLoadingOverlay() {
    document.getElementById('loadingOverlay').classList.remove('d-none');
}

// Hide loading overlay
function hideLoadingOverlay() {
    document.getElementById('loadingOverlay').classList.add('d-none');
}

// Add CSS for rotating animation
const style = document.createElement('style');
style.textContent = `
    .rotating {
        animation: rotate 1s linear infinite;
    }
    
    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}