{% extends "base.html" %}

{% block title %}Enamel Control - Ceramic QC{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h3 mb-0">
                <i class="bi bi-palette text-secondary"></i> Enamel Control
            </h1>
            {% if not form %}
            <a href="{{ url_for('enamel.add_enamel_control') }}" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i> Add Enamel Control
            </a>
            {% endif %}
        </div>
        <p class="text-muted">Monitor enamel preparation and application (PDE 1x/day + Production Lines 12x/day)</p>
    </div>
</div>

<!-- Specifications Reference -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-info-circle text-info"></i> Enamel Specifications</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <strong>Density Specifications (g/l):</strong>
                        <ul class="list-unstyled mt-2">
                            <li><span class="badge bg-primary">Engobe:</span> 1780 - 1830</li>
                            <li><span class="badge bg-success">Email:</span> 1730 - 1780</li>
                            <li><span class="badge bg-warning">Mate:</span> 1780 - 1830</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <strong>Viscosity & Quality:</strong>
                        <ul class="list-unstyled mt-2">
                            <li><span class="badge bg-info">Viscosity:</span> 25 - 55 seconds (all types)</li>
                            <li><span class="badge bg-secondary">Sieve Refusal:</span> Check limits</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <strong>Grammage by Format:</strong>
                        <ul class="list-unstyled mt-2">
                            <li><span class="badge bg-dark">Water:</span> 20x20(0.5-3g), 25x40(1-5g), 25x50(3-7g)</li>
                            <li><span class="badge bg-dark">Enamel:</span> 20x20(20-23g), 25x40(50-55g), 25x50(70-75g)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if form %}
<!-- Add/Edit Form -->
<div class="row">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    {% if edit %}
                        <i class="bi bi-pencil"></i> Edit Enamel Control Record
                    {% else %}
                        <i class="bi bi-plus-lg"></i> Add New Enamel Control Record
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="enamelControlForm">
                    {{ form.hidden_tag() }}
                    
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            {{ form.date.label(class="form-label") }}
                            {{ form.date(class="form-control") }}
                        </div>
                        <div class="col-md-3 mb-3">
                            {{ form.shift.label(class="form-label") }}
                            {{ form.shift(class="form-control") }}
                        </div>
                        <div class="col-md-3 mb-3">
                            {{ form.measurement_type.label(class="form-label") }}
                            {{ form.measurement_type(class="form-control", id="measurementType") }}
                        </div>
                        <div class="col-md-3 mb-3">
                            {{ form.measurement_number.label(class="form-label") }}
                            {{ form.measurement_number(class="form-control") }}
                            <small class="text-muted" id="measurementHelp">For production line (1-12)</small>
                        </div>
                    </div>
                    
                    <h6 class="text-muted border-bottom pb-2 mb-3">Enamel Properties</h6>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            {{ form.enamel_type.label(class="form-label") }}
                            {{ form.enamel_type(class="form-control", id="enamelType") }}
                        </div>
                        <div class="col-md-4 mb-3">
                            {{ form.density.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.density(class="form-control", id="densityInput") }}
                                <span class="input-group-text">g/l</span>
                            </div>
                            <small class="text-muted" id="densitySpec">Select enamel type to see specification</small>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-4 mb-3">
                            {{ form.viscosity.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.viscosity(class="form-control", **{"data-min": "25", "data-max": "55"}) }}
                                <span class="input-group-text">sec</span>
                            </div>
                            <small class="text-muted">Spec: 25 - 55 seconds</small>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    
                    <h6 class="text-muted border-bottom pb-2 mb-3">Grammage by Format</h6>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            {{ form.format_type.label(class="form-label") }}
                            {{ form.format_type(class="form-control", id="formatType") }}
                        </div>
                        <div class="col-md-4 mb-3">
                            {{ form.water_grammage.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.water_grammage(class="form-control", id="waterGrammage") }}
                                <span class="input-group-text">g</span>
                            </div>
                            <small class="text-muted" id="waterSpec">Select format to see specification</small>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-4 mb-3">
                            {{ form.enamel_grammage.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.enamel_grammage(class="form-control", id="enamelGrammage") }}
                                <span class="input-group-text">g</span>
                            </div>
                            <small class="text-muted" id="enamelSpec">Select format to see specification</small>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.sieve_refusal.label(class="form-label") }}
                            <div class="input-group">
                                {{ form.sieve_refusal(class="form-control") }}
                                <span class="input-group-text">%</span>
                            </div>
                            <small class="text-muted">Check against limits</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.notes.label(class="form-label") }}
                        {{ form.notes(class="form-control", rows="3") }}
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg"></i> {% if edit %}Update{% else %}Save{% endif %} Record
                        </button>
                        <a href="{{ url_for('enamel.enamel_controls') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Back to List
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-lightbulb text-warning"></i> Enamel Guidelines</h6>
            </div>
            <div class="card-body">
                <h6>Measurement Types:</h6>
                <ul class="list-unstyled">
                    <li><i class="bi bi-flask text-info"></i> PDE: 1x/day preparation</li>
                    <li><i class="bi bi-gear text-info"></i> Production Line: 12x/day</li>
                </ul>
                
                <h6 class="mt-3">Critical Parameters:</h6>
                <ul class="list-unstyled">
                    <li><i class="bi bi-speedometer text-warning"></i> Density (type-specific)</li>
                    <li><i class="bi bi-hourglass text-warning"></i> Viscosity (25-55 sec)</li>
                    <li><i class="bi bi-weight text-warning"></i> Grammage (format-specific)</li>
                </ul>
                
                <div class="alert alert-info mt-3">
                    <i class="bi bi-info-circle"></i>
                    <strong>Note:</strong> Specifications automatically update based on enamel type and format selection.
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- List View -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Enamel Control Records</h5>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" style="width: auto;" 
                            onchange="window.location.href='{{ url_for('enamel.enamel_controls') }}?enamel_type=' + this.value">
                        <option value="">All Enamel Types</option>
                        <option value="engobe" {{ 'selected' if enamel_filter == 'engobe' }}>Engobe</option>
                        <option value="email" {{ 'selected' if enamel_filter == 'email' }}>Email</option>
                        <option value="mate" {{ 'selected' if enamel_filter == 'mate' }}>Mate</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                {% if controls.items %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Enamel Type</th>
                                <th>Density</th>
                                <th>Viscosity</th>
                                <th>Format</th>
                                <th>Grammage</th>
                                <th>Status</th>
                                <th>Controller</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for control in controls.items %}
                            <tr>
                                <td>
                                    {{ control.date.strftime('%Y-%m-%d') }}
                                    {% if control.shift %}
                                        <br><span class="badge bg-secondary">{{ control.shift|title }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'info' if control.measurement_type == 'pde' else 'success' }}">
                                        {{ control.measurement_type|upper }}
                                    </span>
                                    {% if control.measurement_number %}
                                        <br><small>#{{ control.measurement_number }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'primary' if control.enamel_type == 'engobe' else 'success' if control.enamel_type == 'email' else 'warning' }}">
                                        {{ control.enamel_type|title }}
                                    </span>
                                </td>
                                <td>
                                    {% if control.density %}
                                        {{ "%.0f"|format(control.density) }} g/l
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if control.viscosity %}
                                        {{ "%.1f"|format(control.viscosity) }} sec
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if control.format_type %}
                                        <span class="badge bg-dark">{{ control.format_type }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>
                                        {% if control.water_grammage %}W:{{ "%.1f"|format(control.water_grammage) }}g{% endif %}
                                        {% if control.enamel_grammage %}<br>E:{{ "%.1f"|format(control.enamel_grammage) }}g{% endif %}
                                    </small>
                                </td>
                                <td>
                                    {% if control.compliance_status == 'compliant' %}
                                        <span class="badge bg-success">Compliant</span>
                                    {% elif control.compliance_status == 'non_compliant' %}
                                        <span class="badge bg-danger">Non-Compliant</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Partial</span>
                                    {% endif %}
                                </td>
                                <td>{{ control.controller.full_name if control.controller else 'Unknown' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('enamel.edit_enamel_control', id=control.id) }}" 
                                           class="btn btn-outline-primary">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        {% if current_user.role in ['admin', 'quality_manager'] %}
                                        <button type="button" class="btn btn-outline-danger" 
                                                onclick="confirmDelete({{ control.id }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-palette text-muted display-4"></i>
                    <h5 class="text-muted mt-3">No enamel control records found</h5>
                    <p class="text-muted">Start by adding your first enamel control measurement.</p>
                    <a href="{{ url_for('enamel.add_enamel_control') }}" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i> Add First Record
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/validation.js') }}"></script>
<script>
// Enamel and format specifications
const enamelSpecs = {
    'engobe': {density: [1780, 1830]},
    'email': {density: [1730, 1780]},
    'mate': {density: [1780, 1830]}
};

const grammageSpecs = {
    '20x20': {water: [0.5, 3], enamel: [20, 23]},
    '25x40': {water: [1, 5], enamel: [50, 55]},
    '25x50': {water: [3, 7], enamel: [70, 75]}
};

document.addEventListener('DOMContentLoaded', function() {
    initializeValidation('enamelControlForm');
    
    const measurementTypeSelect = document.getElementById('measurementType');
    const enamelTypeSelect = document.getElementById('enamelType');
    const formatTypeSelect = document.getElementById('formatType');
    const densityInput = document.getElementById('densityInput');
    const waterGrammageInput = document.getElementById('waterGrammage');
    const enamelGrammageInput = document.getElementById('enamelGrammage');
    const measurementHelp = document.getElementById('measurementHelp');
    const densitySpec = document.getElementById('densitySpec');
    const waterSpec = document.getElementById('waterSpec');
    const enamelSpec = document.getElementById('enamelSpec');
    
    // Update measurement number help text
    if (measurementTypeSelect) {
        measurementTypeSelect.addEventListener('change', function() {
            if (this.value === 'pde') {
                measurementHelp.textContent = 'Daily PDE preparation';
            } else {
                measurementHelp.textContent = 'For production line (1-12)';
            }
        });
    }
    
    // Update density specifications
    if (enamelTypeSelect) {
        enamelTypeSelect.addEventListener('change', function() {
            const enamelType = this.value;
            if (enamelType && enamelSpecs[enamelType]) {
                const specs = enamelSpecs[enamelType];
                densitySpec.textContent = `Spec: ${specs.density[0]} - ${specs.density[1]} g/l`;
                densityInput.setAttribute('data-min', specs.density[0]);
                densityInput.setAttribute('data-max', specs.density[1]);
            } else {
                densitySpec.textContent = 'Select enamel type to see specification';
            }
        });
        
        // Trigger change event if enamel type is already selected
        if (enamelTypeSelect.value) {
            enamelTypeSelect.dispatchEvent(new Event('change'));
        }
    }
    
    // Update grammage specifications
    if (formatTypeSelect) {
        formatTypeSelect.addEventListener('change', function() {
            const format = this.value;
            if (format && grammageSpecs[format]) {
                const specs = grammageSpecs[format];
                
                waterSpec.textContent = `Spec: ${specs.water[0]} - ${specs.water[1]} g`;
                enamelSpec.textContent = `Spec: ${specs.enamel[0]} - ${specs.enamel[1]} g`;
                
                waterGrammageInput.setAttribute('data-min', specs.water[0]);
                waterGrammageInput.setAttribute('data-max', specs.water[1]);
                enamelGrammageInput.setAttribute('data-min', specs.enamel[0]);
                enamelGrammageInput.setAttribute('data-max', specs.enamel[1]);
            } else {
                waterSpec.textContent = 'Select format to see specification';
                enamelSpec.textContent = 'Select format to see specification';
            }
        });
        
        // Trigger change event if format is already selected
        if (formatTypeSelect.value) {
            formatTypeSelect.dispatchEvent(new Event('change'));
        }
    }
});

function confirmDelete(id) {
    if (confirm('Are you sure you want to delete this enamel control record?')) {
        fetch(`/enamel/delete/${id}`, {method: 'POST'})
            .then(() => location.reload());
    }
}
</script>
{% endblock %}
